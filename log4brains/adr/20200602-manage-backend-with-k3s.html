<!DOCTYPE html><html lang="en"><head><meta name="theme-color" content="#2176AE"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500;700&amp;display=swap"/><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><link rel="shortcut icon" type="image/x-icon" href="/v-sekai-proposals/log4brains/favicon.ico"/><meta name="og:image" content="/v-sekai-proposals/log4brains/l4b-static/Log4brains-og.png"/><title>Manage backend resources on one or more physical machines with K3S ADR - Architecture knowledge base of V-Sekai</title><meta name="next-head-count" content="5"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/css/d50ac9751859b3eb4bb6.css" as="style"/><link rel="stylesheet" href="/v-sekai-proposals/log4brains/_next/static/css/d50ac9751859b3eb4bb6.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/main-58ab0a31548da3be79d9.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/commons.e15110c59e990a2b9d16.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/a3e17150ead73d62fba7a33a50672ae3f72841a5.801a9822111e83a35730.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/pages/_app-02e215af84c34c72dcf0.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/364bddfb.28847971f0e02b167249.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/3da477db.e49cd5277ed36ace32c1.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/3b07cb59.4f0af644828e83722dc4.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/b4e962f4.209b5add68e2810d9a93.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/39d4b69998343c06c2f6d09982e0011fc76b6c1e.6868553c766a0e95aa6f.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/45d2d314fc8da5e3d79852782e4a432ad4da6771.51549e4f3459c73f0f60.js" as="script"/><link rel="preload" href="/v-sekai-proposals/log4brains/_next/static/chunks/pages/adr/%5B...slug%5D-ce82ea9cfbf663c4d396.js" as="script"/><style id="jss-server-side">html {
  max-width: 100%;
  box-sizing: border-box;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
*, *::before, *::after {
  box-sizing: inherit;
}
strong, b {
  font-weight: 700;
}
body {
  color: rgba(0, 0, 0, 0.87);
  margin: 0;
  padding: 0 !important;
  font-size: 0.875rem;
  max-width: 100%;
  font-family: "Roboto", "Helvetica", "Arial", sans-serif;
  font-weight: 400;
  line-height: 1.43;
  letter-spacing: 0.01071em;
  background-color: #fff;
}
@media print {
  body {
    background-color: #fff;
  }
}
body::backdrop {
  background-color: #fff;
}
blockquote {
  color: #9e9e9e;
  margin: 0;
  padding: 0 1em;
  border-left: 0.25em solid #F8F8F8;
}
.MuiSvgIcon-root {
  fill: currentColor;
  width: 1em;
  height: 1em;
  display: inline-block;
  font-size: 1.5rem;
  transition: fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  flex-shrink: 0;
  user-select: none;
}
.MuiSvgIcon-colorPrimary {
  color: #2176AE;
}
.MuiSvgIcon-colorSecondary {
  color: #FF007B;
}
.MuiSvgIcon-colorAction {
  color: rgba(0, 0, 0, 0.54);
}
.MuiSvgIcon-colorError {
  color: #ff1744;
}
.MuiSvgIcon-colorDisabled {
  color: rgba(0, 0, 0, 0.26);
}
.MuiSvgIcon-fontSizeInherit {
  font-size: inherit;
}
.MuiSvgIcon-fontSizeSmall {
  font-size: 1.25rem;
}
.MuiSvgIcon-fontSizeLarge {
  font-size: 2.1875rem;
}
.MuiTooltip-popper {
  z-index: 1500;
  pointer-events: none;
}
.MuiTooltip-popperInteractive {
  pointer-events: auto;
}
.MuiTooltip-popperArrow[x-placement*="bottom"] .MuiTooltip-arrow {
  top: 0;
  left: 0;
  margin-top: -0.71em;
  margin-left: 4px;
  margin-right: 4px;
}
.MuiTooltip-popperArrow[x-placement*="top"] .MuiTooltip-arrow {
  left: 0;
  bottom: 0;
  margin-left: 4px;
  margin-right: 4px;
  margin-bottom: -0.71em;
}
.MuiTooltip-popperArrow[x-placement*="right"] .MuiTooltip-arrow {
  left: 0;
  width: 0.71em;
  height: 1em;
  margin-top: 4px;
  margin-left: -0.71em;
  margin-bottom: 4px;
}
.MuiTooltip-popperArrow[x-placement*="left"] .MuiTooltip-arrow {
  right: 0;
  width: 0.71em;
  height: 1em;
  margin-top: 4px;
  margin-right: -0.71em;
  margin-bottom: 4px;
}
.MuiTooltip-popperArrow[x-placement*="left"] .MuiTooltip-arrow::before {
  transform-origin: 0 0;
}
.MuiTooltip-popperArrow[x-placement*="right"] .MuiTooltip-arrow::before {
  transform-origin: 100% 100%;
}
.MuiTooltip-popperArrow[x-placement*="top"] .MuiTooltip-arrow::before {
  transform-origin: 100% 0;
}
.MuiTooltip-popperArrow[x-placement*="bottom"] .MuiTooltip-arrow::before {
  transform-origin: 0 100%;
}
.MuiTooltip-tooltip {
  color: #fff;
  padding: 4px 8px;
  font-size: 0.625rem;
  max-width: 300px;
  word-wrap: break-word;
  font-family: "Roboto", "Helvetica", "Arial", sans-serif;
  font-weight: 500;
  line-height: 1.4em;
  border-radius: 4px;
  background-color: rgba(97, 97, 97, 0.9);
}
.MuiTooltip-tooltipArrow {
  margin: 0;
  position: relative;
}
.MuiTooltip-arrow {
  color: rgba(97, 97, 97, 0.9);
  width: 1em;
  height: 0.71em;
  overflow: hidden;
  position: absolute;
  box-sizing: border-box;
}
.MuiTooltip-arrow::before {
  width: 100%;
  height: 100%;
  margin: auto;
  content: "";
  display: block;
  transform: rotate(45deg);
  background-color: currentColor;
}
.MuiTooltip-touch {
  padding: 8px 16px;
  font-size: 0.875rem;
  font-weight: 400;
  line-height: 1.14286em;
}
.MuiTooltip-tooltipPlacementLeft {
  margin: 0 24px ;
  transform-origin: right center;
}
@media (min-width:900px) {
  .MuiTooltip-tooltipPlacementLeft {
    margin: 0 14px;
  }
}
  .MuiTooltip-tooltipPlacementRight {
    margin: 0 24px;
    transform-origin: left center;
  }
@media (min-width:900px) {
  .MuiTooltip-tooltipPlacementRight {
    margin: 0 14px;
  }
}
  .MuiTooltip-tooltipPlacementTop {
    margin: 24px 0;
    transform-origin: center bottom;
  }
@media (min-width:900px) {
  .MuiTooltip-tooltipPlacementTop {
    margin: 14px 0;
  }
}
  .MuiTooltip-tooltipPlacementBottom {
    margin: 24px 0;
    transform-origin: center top;
  }
@media (min-width:900px) {
  .MuiTooltip-tooltipPlacementBottom {
    margin: 14px 0;
  }
}
  .MuiButtonBase-root {
    color: inherit;
    border: 0;
    cursor: pointer;
    margin: 0;
    display: inline-flex;
    outline: 0;
    padding: 0;
    position: relative;
    align-items: center;
    user-select: none;
    border-radius: 0;
    vertical-align: middle;
    -moz-appearance: none;
    justify-content: center;
    text-decoration: none;
    background-color: transparent;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: transparent;
  }
  .MuiButtonBase-root::-moz-focus-inner {
    border-style: none;
  }
  .MuiButtonBase-root.Mui-disabled {
    cursor: default;
    pointer-events: none;
  }
@media print {
  .MuiButtonBase-root {
    color-adjust: exact;
  }
}
  .MuiButton-root {
    color: rgba(0, 0, 0, 0.87);
    padding: 6px 16px;
    font-size: 0.875rem;
    min-width: 64px;
    box-sizing: border-box;
    transition: background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 500;
    line-height: 1.75;
    border-radius: 4px;
    letter-spacing: 0.02857em;
    text-transform: uppercase;
  }
  .MuiButton-root:hover {
    text-decoration: none;
    background-color: rgba(0, 0, 0, 0.04);
  }
  .MuiButton-root.Mui-disabled {
    color: rgba(0, 0, 0, 0.26);
  }
@media (hover: none) {
  .MuiButton-root:hover {
    background-color: transparent;
  }
}
  .MuiButton-root:hover.Mui-disabled {
    background-color: transparent;
  }
  .MuiButton-label {
    width: 100%;
    display: inherit;
    align-items: inherit;
    justify-content: inherit;
  }
  .MuiButton-text {
    padding: 6px 8px;
  }
  .MuiButton-textPrimary {
    color: #2176AE;
  }
  .MuiButton-textPrimary:hover {
    background-color: rgba(33, 118, 174, 0.04);
  }
@media (hover: none) {
  .MuiButton-textPrimary:hover {
    background-color: transparent;
  }
}
  .MuiButton-textSecondary {
    color: #FF007B;
  }
  .MuiButton-textSecondary:hover {
    background-color: rgba(255, 0, 123, 0.04);
  }
@media (hover: none) {
  .MuiButton-textSecondary:hover {
    background-color: transparent;
  }
}
  .MuiButton-outlined {
    border: 1px solid rgba(0, 0, 0, 0.23);
    padding: 5px 15px;
  }
  .MuiButton-outlined.Mui-disabled {
    border: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiButton-outlinedPrimary {
    color: #2176AE;
    border: 1px solid rgba(33, 118, 174, 0.5);
  }
  .MuiButton-outlinedPrimary:hover {
    border: 1px solid #2176AE;
    background-color: rgba(33, 118, 174, 0.04);
  }
@media (hover: none) {
  .MuiButton-outlinedPrimary:hover {
    background-color: transparent;
  }
}
  .MuiButton-outlinedSecondary {
    color: #FF007B;
    border: 1px solid rgba(255, 0, 123, 0.5);
  }
  .MuiButton-outlinedSecondary:hover {
    border: 1px solid #FF007B;
    background-color: rgba(255, 0, 123, 0.04);
  }
  .MuiButton-outlinedSecondary.Mui-disabled {
    border: 1px solid rgba(0, 0, 0, 0.26);
  }
@media (hover: none) {
  .MuiButton-outlinedSecondary:hover {
    background-color: transparent;
  }
}
  .MuiButton-contained {
    color: rgba(0, 0, 0, 0.87);
    box-shadow: 0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12);
    background-color: #e0e0e0;
  }
  .MuiButton-contained:hover {
    box-shadow: 0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);
    background-color: #d5d5d5;
  }
  .MuiButton-contained.Mui-focusVisible {
    box-shadow: 0px 3px 5px -1px rgba(0,0,0,0.2),0px 6px 10px 0px rgba(0,0,0,0.14),0px 1px 18px 0px rgba(0,0,0,0.12);
  }
  .MuiButton-contained:active {
    box-shadow: 0px 5px 5px -3px rgba(0,0,0,0.2),0px 8px 10px 1px rgba(0,0,0,0.14),0px 3px 14px 2px rgba(0,0,0,0.12);
  }
  .MuiButton-contained.Mui-disabled {
    color: rgba(0, 0, 0, 0.26);
    box-shadow: none;
    background-color: rgba(0, 0, 0, 0.12);
  }
@media (hover: none) {
  .MuiButton-contained:hover {
    box-shadow: 0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12);
    background-color: #e0e0e0;
  }
}
  .MuiButton-contained:hover.Mui-disabled {
    background-color: rgba(0, 0, 0, 0.12);
  }
  .MuiButton-containedPrimary {
    color: #fff;
    background-color: #2176AE;
  }
  .MuiButton-containedPrimary:hover {
    background-color: rgb(23, 82, 121);
  }
@media (hover: none) {
  .MuiButton-containedPrimary:hover {
    background-color: #2176AE;
  }
}
  .MuiButton-containedSecondary {
    color: #fff;
    background-color: #FF007B;
  }
  .MuiButton-containedSecondary:hover {
    background-color: rgb(178, 0, 86);
  }
@media (hover: none) {
  .MuiButton-containedSecondary:hover {
    background-color: #FF007B;
  }
}
  .MuiButton-disableElevation {
    box-shadow: none;
  }
  .MuiButton-disableElevation:hover {
    box-shadow: none;
  }
  .MuiButton-disableElevation.Mui-focusVisible {
    box-shadow: none;
  }
  .MuiButton-disableElevation:active {
    box-shadow: none;
  }
  .MuiButton-disableElevation.Mui-disabled {
    box-shadow: none;
  }
  .MuiButton-colorInherit {
    color: inherit;
    border-color: currentColor;
  }
  .MuiButton-textSizeSmall {
    padding: 4px 5px;
    font-size: 0.8125rem;
  }
  .MuiButton-textSizeLarge {
    padding: 8px 11px;
    font-size: 0.9375rem;
  }
  .MuiButton-outlinedSizeSmall {
    padding: 3px 9px;
    font-size: 0.8125rem;
  }
  .MuiButton-outlinedSizeLarge {
    padding: 7px 21px;
    font-size: 0.9375rem;
  }
  .MuiButton-containedSizeSmall {
    padding: 4px 10px;
    font-size: 0.8125rem;
  }
  .MuiButton-containedSizeLarge {
    padding: 8px 22px;
    font-size: 0.9375rem;
  }
  .MuiButton-fullWidth {
    width: 100%;
  }
  .MuiButton-startIcon {
    display: inherit;
    margin-left: -4px;
    margin-right: 8px;
  }
  .MuiButton-startIcon.MuiButton-iconSizeSmall {
    margin-left: -2px;
  }
  .MuiButton-endIcon {
    display: inherit;
    margin-left: 8px;
    margin-right: -4px;
  }
  .MuiButton-endIcon.MuiButton-iconSizeSmall {
    margin-right: -2px;
  }
  .MuiButton-iconSizeSmall > *:first-child {
    font-size: 18px;
  }
  .MuiButton-iconSizeMedium > *:first-child {
    font-size: 20px;
  }
  .MuiButton-iconSizeLarge > *:first-child {
    font-size: 22px;
  }
@media (min-width:0px) and (max-width:899.95px) {
  .jss27 {
    display: none;
  }
}
@media (min-width:0px) {
  .jss28 {
    display: none;
  }
}
@media (max-width:899.95px) {
  .jss29 {
    display: none;
  }
}
@media (min-width:900px) and (max-width:1059.95px) {
  .jss30 {
    display: none;
  }
}
@media (min-width:900px) {
  .jss31 {
    display: none;
  }
}
@media (max-width:1059.95px) {
  .jss32 {
    display: none;
  }
}
@media (min-width:1060px) and (max-width:1279.95px) {
  .jss33 {
    display: none;
  }
}
@media (min-width:1060px) {
  .jss34 {
    display: none;
  }
}
@media (max-width:1279.95px) {
  .jss35 {
    display: none;
  }
}
@media (min-width:1280px) and (max-width:1919.95px) {
  .jss36 {
    display: none;
  }
}
@media (min-width:1280px) {
  .jss37 {
    display: none;
  }
}
@media (max-width:1919.95px) {
  .jss38 {
    display: none;
  }
}
@media (min-width:1920px) {
  .jss39 {
    display: none;
  }
}
@media (min-width:1920px) {
  .jss40 {
    display: none;
  }
}
@media (min-width:0px) {
  .jss41 {
    display: none;
  }
}
  .MuiDivider-root {
    border: none;
    height: 1px;
    margin: 0;
    flex-shrink: 0;
    background-color: rgba(0, 0, 0, 0.12);
  }
  .MuiDivider-absolute {
    left: 0;
    width: 100%;
    bottom: 0;
    position: absolute;
  }
  .MuiDivider-inset {
    margin-left: 72px;
  }
  .MuiDivider-light {
    background-color: rgba(0, 0, 0, 0.08);
  }
  .MuiDivider-middle {
    margin-left: 16px;
    margin-right: 16px;
  }
  .MuiDivider-vertical {
    width: 1px;
    height: 100%;
  }
  .MuiDivider-flexItem {
    height: auto;
    align-self: stretch;
  }
  .MuiTypography-root {
    margin: 0;
  }
  .MuiTypography-body2 {
    font-size: 0.875rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 400;
    line-height: 1.43;
    letter-spacing: 0.01071em;
  }
  .MuiTypography-body1 {
    font-size: 1rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 400;
    line-height: 1.5;
    letter-spacing: 0.00938em;
  }
  .MuiTypography-caption {
    font-size: 0.75rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 400;
    line-height: 1.66;
    letter-spacing: 0.03333em;
  }
  .MuiTypography-button {
    font-size: 0.875rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 500;
    line-height: 1.75;
    letter-spacing: 0.02857em;
    text-transform: uppercase;
  }
  .MuiTypography-h1 {
    font-size: 3.5rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 300;
    line-height: 1.167;
    letter-spacing: -0.01562em;
  }
@media (min-width:900px) {
  .MuiTypography-h1 {
    font-size: 5.3556rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h1 {
    font-size: 5.5698rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h1 {
    font-size: 5.9983rem;
  }
}
  .MuiTypography-h2 {
    font-size: 2.375rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 300;
    line-height: 1.2;
    letter-spacing: -0.00833em;
  }
@media (min-width:900px) {
  .MuiTypography-h2 {
    font-size: 3.3333rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h2 {
    font-size: 3.5417rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h2 {
    font-size: 3.75rem;
  }
}
  .MuiTypography-h3 {
    font-size: 2rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: 0em;
  }
@media (min-width:900px) {
  .MuiTypography-h3 {
    font-size: 2.7273rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h3 {
    font-size: 2.7273rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h3 {
    font-size: 2.9545rem;
  }
}
  .MuiTypography-h4 {
    font-size: 1.5625rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 400;
    line-height: 1.235;
    letter-spacing: 0.00735em;
  }
@media (min-width:900px) {
  .MuiTypography-h4 {
    font-size: 2.0243rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h4 {
    font-size: 2.0243rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h4 {
    font-size: 2.0243rem;
  }
}
  .MuiTypography-h5 {
    font-size: 1.25rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 400;
    line-height: 1.334;
    letter-spacing: 0em;
  }
@media (min-width:900px) {
  .MuiTypography-h5 {
    font-size: 1.4993rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h5 {
    font-size: 1.4993rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h5 {
    font-size: 1.4993rem;
  }
}
  .MuiTypography-h6 {
    font-size: 1.125rem;
    font-family: "Roboto Slab", "Noto Serif", "Times New Roman", serif;
    font-weight: 500;
    line-height: 1.6;
    letter-spacing: 0.0075em;
  }
@media (min-width:900px) {
  .MuiTypography-h6 {
    font-size: 1.25rem;
  }
}
@media (min-width:1060px) {
  .MuiTypography-h6 {
    font-size: 1.25rem;
  }
}
@media (min-width:1280px) {
  .MuiTypography-h6 {
    font-size: 1.25rem;
  }
}
  .MuiTypography-subtitle1 {
    font-size: 1rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 400;
    line-height: 1.75;
    letter-spacing: 0.00938em;
  }
  .MuiTypography-subtitle2 {
    font-size: 0.875rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 500;
    line-height: 1.57;
    letter-spacing: 0.00714em;
  }
  .MuiTypography-overline {
    font-size: 0.75rem;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    font-weight: 400;
    line-height: 2.66;
    letter-spacing: 0.08333em;
    text-transform: uppercase;
  }
  .MuiTypography-srOnly {
    width: 1px;
    height: 1px;
    overflow: hidden;
    position: absolute;
  }
  .MuiTypography-alignLeft {
    text-align: left;
  }
  .MuiTypography-alignCenter {
    text-align: center;
  }
  .MuiTypography-alignRight {
    text-align: right;
  }
  .MuiTypography-alignJustify {
    text-align: justify;
  }
  .MuiTypography-noWrap {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .MuiTypography-gutterBottom {
    margin-bottom: 0.35em;
  }
  .MuiTypography-paragraph {
    margin-bottom: 16px;
  }
  .MuiTypography-colorInherit {
    color: inherit;
  }
  .MuiTypography-colorPrimary {
    color: #2176AE;
  }
  .MuiTypography-colorSecondary {
    color: #FF007B;
  }
  .MuiTypography-colorTextPrimary {
    color: rgba(0, 0, 0, 0.87);
  }
  .MuiTypography-colorTextSecondary {
    color: rgba(0, 0, 0, 0.54);
  }
  .MuiTypography-colorError {
    color: #ff1744;
  }
  .MuiTypography-displayInline {
    display: inline;
  }
  .MuiTypography-displayBlock {
    display: block;
  }
  .MuiLink-root:hover {
    color: rgb(23, 82, 121);
  }
  .MuiLink-underlineNone {
    text-decoration: none;
  }
  .MuiLink-underlineHover {
    text-decoration: none;
  }
  .MuiLink-underlineHover:hover {
    text-decoration: underline;
  }
  .MuiLink-underlineAlways {
    text-decoration: underline;
  }
  .MuiLink-button {
    border: 0;
    cursor: pointer;
    margin: 0;
    outline: 0;
    padding: 0;
    position: relative;
    user-select: none;
    border-radius: 0;
    vertical-align: middle;
    -moz-appearance: none;
    background-color: transparent;
    -webkit-appearance: none;
    -webkit-tap-highlight-color: transparent;
  }
  .MuiLink-button::-moz-focus-inner {
    border-style: none;
  }
  .MuiLink-button.Mui-focusVisible {
    outline: auto;
  }
  .MuiPaper-root {
    color: rgba(0, 0, 0, 0.87);
    transition: box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    background-color: #fff;
  }
  .MuiPaper-rounded {
    border-radius: 4px;
  }
  .MuiPaper-outlined {
    border: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiPaper-elevation0 {
    box-shadow: none;
  }
  .MuiPaper-elevation1 {
    box-shadow: 0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation2 {
    box-shadow: 0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation3 {
    box-shadow: 0px 3px 3px -2px rgba(0,0,0,0.2),0px 3px 4px 0px rgba(0,0,0,0.14),0px 1px 8px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation4 {
    box-shadow: 0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation5 {
    box-shadow: 0px 3px 5px -1px rgba(0,0,0,0.2),0px 5px 8px 0px rgba(0,0,0,0.14),0px 1px 14px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation6 {
    box-shadow: 0px 3px 5px -1px rgba(0,0,0,0.2),0px 6px 10px 0px rgba(0,0,0,0.14),0px 1px 18px 0px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation7 {
    box-shadow: 0px 4px 5px -2px rgba(0,0,0,0.2),0px 7px 10px 1px rgba(0,0,0,0.14),0px 2px 16px 1px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation8 {
    box-shadow: 0px 5px 5px -3px rgba(0,0,0,0.2),0px 8px 10px 1px rgba(0,0,0,0.14),0px 3px 14px 2px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation9 {
    box-shadow: 0px 5px 6px -3px rgba(0,0,0,0.2),0px 9px 12px 1px rgba(0,0,0,0.14),0px 3px 16px 2px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation10 {
    box-shadow: 0px 6px 6px -3px rgba(0,0,0,0.2),0px 10px 14px 1px rgba(0,0,0,0.14),0px 4px 18px 3px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation11 {
    box-shadow: 0px 6px 7px -4px rgba(0,0,0,0.2),0px 11px 15px 1px rgba(0,0,0,0.14),0px 4px 20px 3px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation12 {
    box-shadow: 0px 7px 8px -4px rgba(0,0,0,0.2),0px 12px 17px 2px rgba(0,0,0,0.14),0px 5px 22px 4px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation13 {
    box-shadow: 0px 7px 8px -4px rgba(0,0,0,0.2),0px 13px 19px 2px rgba(0,0,0,0.14),0px 5px 24px 4px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation14 {
    box-shadow: 0px 7px 9px -4px rgba(0,0,0,0.2),0px 14px 21px 2px rgba(0,0,0,0.14),0px 5px 26px 4px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation15 {
    box-shadow: 0px 8px 9px -5px rgba(0,0,0,0.2),0px 15px 22px 2px rgba(0,0,0,0.14),0px 6px 28px 5px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation16 {
    box-shadow: 0px 8px 10px -5px rgba(0,0,0,0.2),0px 16px 24px 2px rgba(0,0,0,0.14),0px 6px 30px 5px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation17 {
    box-shadow: 0px 8px 11px -5px rgba(0,0,0,0.2),0px 17px 26px 2px rgba(0,0,0,0.14),0px 6px 32px 5px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation18 {
    box-shadow: 0px 9px 11px -5px rgba(0,0,0,0.2),0px 18px 28px 2px rgba(0,0,0,0.14),0px 7px 34px 6px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation19 {
    box-shadow: 0px 9px 12px -6px rgba(0,0,0,0.2),0px 19px 29px 2px rgba(0,0,0,0.14),0px 7px 36px 6px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation20 {
    box-shadow: 0px 10px 13px -6px rgba(0,0,0,0.2),0px 20px 31px 3px rgba(0,0,0,0.14),0px 8px 38px 7px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation21 {
    box-shadow: 0px 10px 13px -6px rgba(0,0,0,0.2),0px 21px 33px 3px rgba(0,0,0,0.14),0px 8px 40px 7px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation22 {
    box-shadow: 0px 10px 14px -6px rgba(0,0,0,0.2),0px 22px 35px 3px rgba(0,0,0,0.14),0px 8px 42px 7px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation23 {
    box-shadow: 0px 11px 14px -7px rgba(0,0,0,0.2),0px 23px 36px 3px rgba(0,0,0,0.14),0px 9px 44px 8px rgba(0,0,0,0.12);
  }
  .MuiPaper-elevation24 {
    box-shadow: 0px 11px 15px -7px rgba(0,0,0,0.2),0px 24px 38px 3px rgba(0,0,0,0.14),0px 9px 46px 8px rgba(0,0,0,0.12);
  }
  .MuiIconButton-root {
    flex: 0 0 auto;
    color: rgba(0, 0, 0, 0.54);
    padding: 12px;
    overflow: visible;
    font-size: 1.5rem;
    text-align: center;
    transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    border-radius: 50%;
  }
  .MuiIconButton-root:hover {
    background-color: rgba(0, 0, 0, 0.04);
  }
  .MuiIconButton-root.Mui-disabled {
    color: rgba(0, 0, 0, 0.26);
    background-color: transparent;
  }
@media (hover: none) {
  .MuiIconButton-root:hover {
    background-color: transparent;
  }
}
  .MuiIconButton-edgeStart {
    margin-left: -12px;
  }
  .MuiIconButton-sizeSmall.MuiIconButton-edgeStart {
    margin-left: -3px;
  }
  .MuiIconButton-edgeEnd {
    margin-right: -12px;
  }
  .MuiIconButton-sizeSmall.MuiIconButton-edgeEnd {
    margin-right: -3px;
  }
  .MuiIconButton-colorInherit {
    color: inherit;
  }
  .MuiIconButton-colorPrimary {
    color: #2176AE;
  }
  .MuiIconButton-colorPrimary:hover {
    background-color: rgba(33, 118, 174, 0.04);
  }
@media (hover: none) {
  .MuiIconButton-colorPrimary:hover {
    background-color: transparent;
  }
}
  .MuiIconButton-colorSecondary {
    color: #FF007B;
  }
  .MuiIconButton-colorSecondary:hover {
    background-color: rgba(255, 0, 123, 0.04);
  }
@media (hover: none) {
  .MuiIconButton-colorSecondary:hover {
    background-color: transparent;
  }
}
  .MuiIconButton-sizeSmall {
    padding: 3px;
    font-size: 1.125rem;
  }
  .MuiIconButton-label {
    width: 100%;
    display: flex;
    align-items: inherit;
    justify-content: inherit;
  }
  .MuiAppBar-root {
    width: 100%;
    display: flex;
    z-index: 1100;
    box-sizing: border-box;
    flex-shrink: 0;
    flex-direction: column;
  }
  .MuiAppBar-positionFixed {
    top: 0;
    left: auto;
    right: 0;
    position: fixed;
  }
@media print {
  .MuiAppBar-positionFixed {
    position: absolute;
  }
}
  .MuiAppBar-positionAbsolute {
    top: 0;
    left: auto;
    right: 0;
    position: absolute;
  }
  .MuiAppBar-positionSticky {
    top: 0;
    left: auto;
    right: 0;
    position: sticky;
  }
  .MuiAppBar-positionStatic {
    position: static;
  }
  .MuiAppBar-positionRelative {
    position: relative;
  }
  .MuiAppBar-colorDefault {
    color: rgba(0, 0, 0, 0.87);
    background-color: #f5f5f5;
  }
  .MuiAppBar-colorPrimary {
    color: #fff;
    background-color: #2176AE;
  }
  .MuiAppBar-colorSecondary {
    color: #fff;
    background-color: #FF007B;
  }
  .MuiAppBar-colorInherit {
    color: inherit;
  }
  .MuiAppBar-colorTransparent {
    color: inherit;
    background-color: transparent;
  }
  .MuiBackdrop-root {
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    z-index: -1;
    position: fixed;
    align-items: center;
    justify-content: center;
    background-color: rgba(0, 0, 0, 0.5);
    -webkit-tap-highlight-color: transparent;
  }
  .MuiBackdrop-invisible {
    background-color: transparent;
  }
  .MuiButtonGroup-root {
    display: inline-flex;
    border-radius: 4px;
  }
  .MuiButtonGroup-contained {
    box-shadow: 0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12);
  }
  .MuiButtonGroup-disableElevation {
    box-shadow: none;
  }
  .MuiButtonGroup-fullWidth {
    width: 100%;
  }
  .MuiButtonGroup-vertical {
    flex-direction: column;
  }
  .MuiButtonGroup-grouped {
    min-width: 40px;
  }
  .MuiButtonGroup-groupedHorizontal:not(:first-child) {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
  }
  .MuiButtonGroup-groupedHorizontal:not(:last-child) {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
  }
  .MuiButtonGroup-groupedVertical:not(:first-child) {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }
  .MuiButtonGroup-groupedVertical:not(:last-child) {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }
  .MuiButtonGroup-groupedTextHorizontal:not(:last-child) {
    border-right: 1px solid rgba(0, 0, 0, 0.23);
  }
  .MuiButtonGroup-groupedTextVertical:not(:last-child) {
    border-bottom: 1px solid rgba(0, 0, 0, 0.23);
  }
  .MuiButtonGroup-groupedTextPrimary:not(:last-child) {
    border-color: rgba(33, 118, 174, 0.5);
  }
  .MuiButtonGroup-groupedTextSecondary:not(:last-child) {
    border-color: rgba(255, 0, 123, 0.5);
  }
  .MuiButtonGroup-groupedOutlinedHorizontal:not(:first-child) {
    margin-left: -1px;
  }
  .MuiButtonGroup-groupedOutlinedHorizontal:not(:last-child) {
    border-right-color: transparent;
  }
  .MuiButtonGroup-groupedOutlinedVertical:not(:first-child) {
    margin-top: -1px;
  }
  .MuiButtonGroup-groupedOutlinedVertical:not(:last-child) {
    border-bottom-color: transparent;
  }
  .MuiButtonGroup-groupedOutlinedPrimary:hover {
    border-color: #2176AE;
  }
  .MuiButtonGroup-groupedOutlinedSecondary:hover {
    border-color: #FF007B;
  }
  .MuiButtonGroup-groupedContained {
    box-shadow: none;
  }
  .MuiButtonGroup-groupedContainedHorizontal:not(:last-child) {
    border-right: 1px solid #bdbdbd;
  }
  .MuiButtonGroup-groupedContainedHorizontal:not(:last-child).Mui-disabled {
    border-right: 1px solid rgba(0, 0, 0, 0.26);
  }
  .MuiButtonGroup-groupedContainedVertical:not(:last-child) {
    border-bottom: 1px solid #bdbdbd;
  }
  .MuiButtonGroup-groupedContainedVertical:not(:last-child).Mui-disabled {
    border-bottom: 1px solid rgba(0, 0, 0, 0.26);
  }
  .MuiButtonGroup-groupedContainedPrimary:not(:last-child) {
    border-color: rgb(23, 82, 121);
  }
  .MuiButtonGroup-groupedContainedSecondary:not(:last-child) {
    border-color: rgb(178, 0, 86);
  }
  .MuiChip-root {
    color: rgba(0, 0, 0, 0.87);
    border: none;
    cursor: default;
    height: 32px;
    display: inline-flex;
    outline: 0;
    padding: 0;
    font-size: 0.8125rem;
    box-sizing: border-box;
    transition: background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
    align-items: center;
    font-family: "Roboto", "Helvetica", "Arial", sans-serif;
    white-space: nowrap;
    border-radius: 16px;
    vertical-align: middle;
    justify-content: center;
    text-decoration: none;
    background-color: #e0e0e0;
  }
  .MuiChip-root.Mui-disabled {
    opacity: 0.5;
    pointer-events: none;
  }
  .MuiChip-root .MuiChip-avatar {
    color: #616161;
    width: 24px;
    height: 24px;
    font-size: 0.75rem;
    margin-left: 5px;
    margin-right: -6px;
  }
  .MuiChip-root .MuiChip-avatarColorPrimary {
    color: #fff;
    background-color: rgb(23, 82, 121);
  }
  .MuiChip-root .MuiChip-avatarColorSecondary {
    color: #fff;
    background-color: rgb(178, 0, 86);
  }
  .MuiChip-root .MuiChip-avatarSmall {
    width: 18px;
    height: 18px;
    font-size: 0.625rem;
    margin-left: 4px;
    margin-right: -4px;
  }
  .MuiChip-sizeSmall {
    height: 24px;
  }
  .MuiChip-colorPrimary {
    color: #fff;
    background-color: #2176AE;
  }
  .MuiChip-colorSecondary {
    color: #fff;
    background-color: #FF007B;
  }
  .MuiChip-clickable {
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  .MuiChip-clickable:hover, .MuiChip-clickable:focus {
    background-color: rgb(206, 206, 206);
  }
  .MuiChip-clickable:active {
    box-shadow: 0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);
  }
  .MuiChip-clickableColorPrimary:hover, .MuiChip-clickableColorPrimary:focus {
    background-color: rgb(50, 128, 180);
  }
  .MuiChip-clickableColorSecondary:hover, .MuiChip-clickableColorSecondary:focus {
    background-color: rgb(255, 20, 133);
  }
  .MuiChip-deletable:focus {
    background-color: rgb(206, 206, 206);
  }
  .MuiChip-deletableColorPrimary:focus {
    background-color: rgb(77, 145, 190);
  }
  .MuiChip-deletableColorSecondary:focus {
    background-color: rgb(255, 51, 149);
  }
  .MuiChip-outlined {
    border: 1px solid rgba(0, 0, 0, 0.23);
    background-color: transparent;
  }
  .MuiChip-clickable.MuiChip-outlined:hover, .MuiChip-clickable.MuiChip-outlined:focus, .MuiChip-deletable.MuiChip-outlined:focus {
    background-color: rgba(0, 0, 0, 0.04);
  }
  .MuiChip-outlined .MuiChip-avatar {
    margin-left: 4px;
  }
  .MuiChip-outlined .MuiChip-avatarSmall {
    margin-left: 2px;
  }
  .MuiChip-outlined .MuiChip-icon {
    margin-left: 4px;
  }
  .MuiChip-outlined .MuiChip-iconSmall {
    margin-left: 2px;
  }
  .MuiChip-outlined .MuiChip-deleteIcon {
    margin-right: 5px;
  }
  .MuiChip-outlined .MuiChip-deleteIconSmall {
    margin-right: 3px;
  }
  .MuiChip-outlinedPrimary {
    color: #2176AE;
    border: 1px solid #2176AE;
  }
  .MuiChip-clickable.MuiChip-outlinedPrimary:hover, .MuiChip-clickable.MuiChip-outlinedPrimary:focus, .MuiChip-deletable.MuiChip-outlinedPrimary:focus {
    background-color: rgba(33, 118, 174, 0.04);
  }
  .MuiChip-outlinedSecondary {
    color: #FF007B;
    border: 1px solid #FF007B;
  }
  .MuiChip-clickable.MuiChip-outlinedSecondary:hover, .MuiChip-clickable.MuiChip-outlinedSecondary:focus, .MuiChip-deletable.MuiChip-outlinedSecondary:focus {
    background-color: rgba(255, 0, 123, 0.04);
  }
  .MuiChip-icon {
    color: #616161;
    margin-left: 5px;
    margin-right: -6px;
  }
  .MuiChip-iconSmall {
    width: 18px;
    height: 18px;
    margin-left: 4px;
    margin-right: -4px;
  }
  .MuiChip-iconColorPrimary {
    color: inherit;
  }
  .MuiChip-iconColorSecondary {
    color: inherit;
  }
  .MuiChip-label {
    overflow: hidden;
    white-space: nowrap;
    padding-left: 12px;
    padding-right: 12px;
    text-overflow: ellipsis;
  }
  .MuiChip-labelSmall {
    padding-left: 8px;
    padding-right: 8px;
  }
  .MuiChip-deleteIcon {
    color: rgba(0, 0, 0, 0.26);
    width: 22px;
    cursor: pointer;
    height: 22px;
    margin: 0 5px 0 -6px;
    -webkit-tap-highlight-color: transparent;
  }
  .MuiChip-deleteIcon:hover {
    color: rgba(0, 0, 0, 0.4);
  }
  .MuiChip-deleteIconSmall {
    width: 16px;
    height: 16px;
    margin-left: -4px;
    margin-right: 4px;
  }
  .MuiChip-deleteIconColorPrimary {
    color: rgba(255, 255, 255, 0.7);
  }
  .MuiChip-deleteIconColorPrimary:hover, .MuiChip-deleteIconColorPrimary:active {
    color: #fff;
  }
  .MuiChip-deleteIconColorSecondary {
    color: rgba(255, 255, 255, 0.7);
  }
  .MuiChip-deleteIconColorSecondary:hover, .MuiChip-deleteIconColorSecondary:active {
    color: #fff;
  }
  .MuiChip-deleteIconOutlinedColorPrimary {
    color: rgba(33, 118, 174, 0.7);
  }
  .MuiChip-deleteIconOutlinedColorPrimary:hover, .MuiChip-deleteIconOutlinedColorPrimary:active {
    color: #2176AE;
  }
  .MuiChip-deleteIconOutlinedColorSecondary {
    color: rgba(255, 0, 123, 0.7);
  }
  .MuiChip-deleteIconOutlinedColorSecondary:hover, .MuiChip-deleteIconOutlinedColorSecondary:active {
    color: #FF007B;
  }
  .MuiCircularProgress-root {
    display: inline-block;
  }
  .MuiCircularProgress-static {
    transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  }
  .MuiCircularProgress-indeterminate {
    animation: MuiCircularProgress-keyframes-circular-rotate 1.4s linear infinite;
  }
  .MuiCircularProgress-determinate {
    transition: transform 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  }
  .MuiCircularProgress-colorPrimary {
    color: #2176AE;
  }
  .MuiCircularProgress-colorSecondary {
    color: #FF007B;
  }
  .MuiCircularProgress-svg {
    display: block;
  }
  .MuiCircularProgress-circle {
    stroke: currentColor;
  }
  .MuiCircularProgress-circleStatic {
    transition: stroke-dashoffset 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  }
  .MuiCircularProgress-circleIndeterminate {
    animation: MuiCircularProgress-keyframes-circular-dash 1.4s ease-in-out infinite;
    stroke-dasharray: 80px, 200px;
    stroke-dashoffset: 0px;
  }
  .MuiCircularProgress-circleDeterminate {
    transition: stroke-dashoffset 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  }
@keyframes MuiCircularProgress-keyframes-circular-rotate {
  0% {
    transform-origin: 50% 50%;
  }
  100% {
    transform: rotate(360deg);
  }
}
@keyframes MuiCircularProgress-keyframes-circular-dash {
  0% {
    stroke-dasharray: 1px, 200px;
    stroke-dashoffset: 0px;
  }
  50% {
    stroke-dasharray: 100px, 200px;
    stroke-dashoffset: -15px;
  }
  100% {
    stroke-dasharray: 100px, 200px;
    stroke-dashoffset: -125px;
  }
}
  .MuiCircularProgress-circleDisableShrink {
    animation: none;
  }
  .MuiDrawer-docked {
    flex: 0 0 auto;
  }
  .MuiDrawer-paper {
    top: 0;
    flex: 1 0 auto;
    height: 100%;
    display: flex;
    outline: 0;
    z-index: 1200;
    position: fixed;
    overflow-y: auto;
    flex-direction: column;
    -webkit-overflow-scrolling: touch;
  }
  .MuiDrawer-paperAnchorLeft {
    left: 0;
    right: auto;
  }
  .MuiDrawer-paperAnchorRight {
    left: auto;
    right: 0;
  }
  .MuiDrawer-paperAnchorTop {
    top: 0;
    left: 0;
    right: 0;
    bottom: auto;
    height: auto;
    max-height: 100%;
  }
  .MuiDrawer-paperAnchorBottom {
    top: auto;
    left: 0;
    right: 0;
    bottom: 0;
    height: auto;
    max-height: 100%;
  }
  .MuiDrawer-paperAnchorDockedLeft {
    border-right: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiDrawer-paperAnchorDockedTop {
    border-bottom: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiDrawer-paperAnchorDockedRight {
    border-left: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiDrawer-paperAnchorDockedBottom {
    border-top: 1px solid rgba(0, 0, 0, 0.12);
  }
  .MuiList-root {
    margin: 0;
    padding: 0;
    position: relative;
    list-style: none;
  }
  .MuiList-padding {
    padding-top: 8px;
    padding-bottom: 8px;
  }
  .MuiList-subheader {
    padding-top: 0;
  }
  .MuiSnackbar-root {
    left: 8px;
    right: 8px;
    display: flex;
    z-index: 1400;
    position: fixed;
    align-items: center;
    justify-content: center;
  }
  .MuiSnackbar-anchorOriginTopCenter {
    top: 8px;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginTopCenter {
    top: 24px;
    left: 50%;
    right: auto;
    transform: translateX(-50%);
  }
}
  .MuiSnackbar-anchorOriginBottomCenter {
    bottom: 8px;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginBottomCenter {
    left: 50%;
    right: auto;
    bottom: 24px;
    transform: translateX(-50%);
  }
}
  .MuiSnackbar-anchorOriginTopRight {
    top: 8px;
    justify-content: flex-end;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginTopRight {
    top: 24px;
    left: auto;
    right: 24px;
  }
}
  .MuiSnackbar-anchorOriginBottomRight {
    bottom: 8px;
    justify-content: flex-end;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginBottomRight {
    left: auto;
    right: 24px;
    bottom: 24px;
  }
}
  .MuiSnackbar-anchorOriginTopLeft {
    top: 8px;
    justify-content: flex-start;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginTopLeft {
    top: 24px;
    left: 24px;
    right: auto;
  }
}
  .MuiSnackbar-anchorOriginBottomLeft {
    bottom: 8px;
    justify-content: flex-start;
  }
@media (min-width:900px) {
  .MuiSnackbar-anchorOriginBottomLeft {
    left: 24px;
    right: auto;
    bottom: 24px;
  }
}
  .MuiToolbar-root {
    display: flex;
    position: relative;
    align-items: center;
  }
  .MuiToolbar-gutters {
    padding-left: 16px;
    padding-right: 16px;
  }
@media (min-width:900px) {
  .MuiToolbar-gutters {
    padding-left: 24px;
    padding-right: 24px;
  }
}
  .MuiToolbar-regular {
    min-height: 56px;
  }
@media (min-width:0px) and (orientation: landscape) {
  .MuiToolbar-regular {
    min-height: 48px;
  }
}
@media (min-width:900px) {
  .MuiToolbar-regular {
    min-height: 64px;
  }
}
  .MuiToolbar-dense {
    min-height: 48px;
  }
  .jss80 {
    height: 18px;
    font-size: 0.74rem;
    font-weight: 500;
    vertical-align: text-bottom;
  }
  .jss81 {
    padding: 0 6px;
  }
  .jss82 {
    color: #424242;
  }
  .jss83 {
    color: #283593;
  }
  .jss84 {
    color: #d84315;
  }
  .jss85 {
    color: #558b2f;
  }
  .jss86 {
    color: #6d4c41;
  }
  .jss87 {
    color: #6d4c41;
  }
  .jss88:hover .jss89 {
    visibility: visible;
  }
  .jss89 {
    color: inherit;
    visibility: hidden;
    margin-left: 0.3ch;
  }
  .jss89:hover {
    color: #2176AE;
  }
  .jss90 {
    padding: 3px;
    border-radius: 4px;
    background-color: #F8F8F8;
  }
  .jss92 > ul {
    padding: 0 !important;
  }
  .jss93 {
    font-weight: 700;
    padding-bottom: 8px;
  }
  .jss94 {
    padding-left: 1rem;
    list-style-type: none;
  }
  .jss71 {
    display: flex;
  }
  .jss72 {
    flex-grow: 0.5;
  }
@media (max-width:1279.95px) {
  .jss72 {
    display: none;
  }
}
  .jss73 {
    flex-grow: 1;
    padding-left: 16px;
    overflow-wrap: anywhere;
    padding-right: 16px;
  }
@media (min-width:1060px) {
  .jss73 {
    flex-grow: 0;
    flex-basis: 782px;
    flex-shrink: 0;
    padding-left: 32px;
    padding-right: 32px;
  }
}
  .jss73 img {
    max-width: 100%;
  }
  .jss74 {
    flex-grow: 1;
    flex-basis: 180px;
  }
@media (max-width:1279.95px) {
  .jss74 {
    display: none;
  }
}
  .jss75 {
    top: 112px;
    position: sticky;
    min-width: 20ch;
    align-self: flex-start;
    padding-left: 16px;
  }
  .jss43 {
    padding: 0;
  }
  .jss44 {
    display: block;
  }
  .jss45:hover .jss57 {
    background-color: #2176AE;
  }
  .jss46 .jss57 {
    background-color: #FF007B;
  }
  .jss46 .jss44 {
    color: #FF007B;
  }
  .jss46 .jss44:hover {
    color: #FF007B;
  }
  .jss46:hover .jss57 {
    background-color: #FF007B;
  }
  .jss47 {
    flex: 0 0 calc(12ch - 11.5px);
  }
  .jss48 {
    flex: 0 0 12ch;
  }
  .jss49 {
    width: 35px;
    height: 35px;
  }
  .jss50 {
    color: #9e9e9e;
    font-size: 0.8rem;
  }
  .jss51 {
    margin-left: -1ch;
  }
  .jss52 {
    vertical-align: middle;
  }
  .jss53 {
    margin-right: 0.5ch;
  }
  .jss54 {
    color: #616161;
    font-size: 0.8rem;
    white-space: pre;
    vertical-align: text-top;
  }
  .jss55 {
    flex: 0 0 calc(12ch - 12px);
  }
  .jss56 {
    padding-bottom: 16px;
  }
  .jss58 {
    background-color: #FF007B;
  }
  .jss62 {
    text-decoration: line-through;
  }
  .jss63 {
    text-decoration: line-through;
  }
  .jss64 {
    text-decoration: line-through;
  }
  .jss1 {
    display: flex;
  }
  .jss2 {
    flex-grow: 0.5;
  }
@media (max-width:1279.95px) {
  .jss2 {
    display: none;
  }
}
  .jss3 {
    flex-grow: 1;
    padding-left: 32px;
    padding-right: 32px;
  }
@media (min-width:1060px) {
  .jss3 {
    flex-grow: 0;
    flex-basis: 782px;
    flex-shrink: 0;
  }
}
  .jss4 {
    flex-grow: 1;
    flex-basis: 180px;
  }
@media (max-width:1279.95px) {
  .jss4 {
    display: none;
  }
}
  .jss5 {
    z-index: 1201;
  }
@media (min-width:900px) {
  .jss6 {
    display: none;
  }
}
  .jss7 {
    display: none;
  }
@media (min-width:900px) {
  .jss7 {
    width: 356px;
    cursor: pointer;
    display: flex;
    flex-grow: 0;
    align-items: center;
    flex-shrink: 0;
  }
}
  .jss8 {
    color: inherit;
    display: block;
    margin-left: 16px;
  }
  .jss8:hover {
    color: inherit;
  }
  .jss9 {
    z-index: 1298;
  }
  .jss10 {
    width: 100%;
    z-index: 1299;
    transition: width 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;
  }
@media (min-width:1060px) {
  .jss10 {
    width: 70%;
  }
}
  .jss11 {
    width: 100%;
  }
@media (min-width:900px) {
  .jss12 {
    width: 380px;
    flex-shrink: 0;
  }
}
  .jss13 {
    width: 380px;
  }
  .jss14 {
    height: 100%;
    display: flex;
    flex-direction: column;
  }
@media (min-width:900px) {
  .jss14 {
    padding-top: 48px;
  }
}
  .jss15 {
    visibility: visible;
    justify-content: space-between;
  }
@media (min-width:900px) {
  .jss15 {
    visibility: hidden;
  }
}
  .jss16 {
    overflow: auto;
    flex-grow: 1;
    flex-shrink: 1;
  }
  .jss16::-webkit-scrollbar {
    width: 6px;
    background-color: [object Object];
  }
  .jss16::-webkit-scrollbar-thumb {
    border-radius: 10px;
    background-color: #bdbdbd;
    -webkit-box-shadow: inset 0 0 2px rgba(0,0,0,.3);
  }
  .jss17 {
    flex-grow: 0;
    flex-shrink: 0;
  }
  .jss18 {
    display: flex;
    padding-left: 16px;
    padding-right: 24px;
    padding-bottom: 4px;
    justify-content: space-between;
  }
@media (min-width:900px) {
  .jss18 {
    padding-left: 24px;
  }
}
  .jss19 {
    font-weight: 700;
  }
  .jss20 {
    align-self: center;
    margin-top: 30vh;
  }
  .jss21 {
    flex-grow: 1;
    padding-top: 16px;
  }
@media (min-width:900px) {
  .jss21 {
    padding-top: 48px;
  }
}
  .jss22 {
    min-height: calc(100vh - 35px - 72px);
  }
@media (min-width:900px) {
  .jss22 {
    min-height: calc(100vh - 35px - 112px);
  }
}
  .jss23 {
    color: #9e9e9e;
    height: 35px;
    display: flex;
    margin-top: 48px;
    background-color: #f5f5f5;
  }
  .jss24 {
    font-size: 0.77rem;
  }
  .jss25 {
    color: #757575;
    font-size: 0.8rem;
  }
  .jss25:hover {
    color: #424242;
  }
  .jss26 {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .jss76 {
    color: #616161;
    display: flex;
    justify-content: space-between;
  }
  .jss77 {
    display: flex;
  }
  .jss77 > * {
    margin-left: 4px;
    margin-right: 4px;
  }
  .jss77 > *:first-child {
    margin-left: 0;
  }
  .jss77 > *:last-child {
    margin-right: 0;
  }
  .jss78 {
    vertical-align: middle;
  }
  .jss79 {
    color: #757575;
  }
  .jss65 {
    margin-top: 8px;
    margin-bottom: 32px;
  }
  .jss66 {
    margin-bottom: 24px;
  }
  .jss67 {
    margin-top: 96px;
  }
  .jss68 {
    display: flex;
    margin-top: 8px;
    justify-content: space-between;
  }
  .jss70 {
    color: #757575;
    font-size: 0.77rem;
    text-align: center;
  }</style></head><body><div id="__next"><div class="jss1"><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionFixed MuiAppBar-colorPrimary jss5 mui-fixed MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><button class="MuiButtonBase-root MuiIconButton-root jss6 MuiIconButton-colorInherit MuiIconButton-edgeStart" tabindex="0" type="button" aria-label="open drawer"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></span></button><div class="jss7"><div><img src="/v-sekai-proposals/log4brains/l4b-static/Log4brains-logo-dark.png" alt="Log4brains logo" width="50" height="50"/></div><div><a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss8 MuiTypography-h6 MuiTypography-colorPrimary MuiTypography-noWrap" href="/v-sekai-proposals/log4brains">V-Sekai</a><a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss8 MuiTypography-body2 MuiTypography-colorPrimary MuiTypography-noWrap" href="/v-sekai-proposals/log4brains">Architecture knowledge base</a></div></div><div class="jss2"></div><div class="jss3"><div class="MuiBackdrop-root jss9" aria-hidden="true" style="opacity:0;visibility:hidden"></div></div><div class="jss4"></div></div></header><nav class="jss12" aria-label="architecture decision records list"><div class="jss31"></div><div class="jss29"><div class="MuiDrawer-root MuiDrawer-docked"><div class="MuiPaper-root MuiDrawer-paper jss13 MuiDrawer-paperAnchorLeft MuiDrawer-paperAnchorDockedLeft MuiPaper-elevation0"><div class="jss14"><div class="MuiToolbar-root MuiToolbar-regular jss15 MuiToolbar-gutters"><div></div><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeSmall" tabindex="0" aria-disabled="false" aria-label="go to homepage" title="Architecture knowledge base of V-Sekai" href="/v-sekai-proposals/log4brains"><span class="MuiIconButton-label"><img src="/v-sekai-proposals/log4brains/l4b-static/Log4brains-logo.png" alt="Log4brains logo" width="40" height="40"/></span></a><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeSmall" tabindex="0" type="button" aria-label="close drawer" title="Close"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></span></button></div><div class="jss18"><h6 class="MuiTypography-root jss19 MuiTypography-subtitle2">Decision log</h6><div class="MuiCircularProgress-root MuiCircularProgress-colorPrimary MuiCircularProgress-indeterminate" style="width:13px;height:13px;opacity:0;visibility:hidden" role="progressbar"><svg class="MuiCircularProgress-svg" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></div></div><div class="MuiCircularProgress-root jss20 MuiCircularProgress-colorPrimary MuiCircularProgress-indeterminate" style="width:30px;height:30px" role="progressbar"><svg class="MuiCircularProgress-svg" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></div><ul class="MuiList-root jss17 MuiList-padding"></ul></div></div></div></div></nav><div class="jss21"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"></div><main class="jss22"><div class="jss71"><div class="jss72"></div><div class="jss73"><h3 class="MuiTypography-root MuiTypography-h3 MuiTypography-gutterBottom">Manage backend resources on one or more physical machines with K3S</h3><hr class="MuiDivider-root"/><div class="jss65 jss76"><div><div class="jss77"><p class="MuiTypography-root MuiTypography-body2" title="Creation date"><svg class="MuiSvgIcon-root jss78 MuiSvgIcon-fontSizeInherit" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"></path></svg> <!-- -->May 29, 2021</p><div title="Status"><div class="MuiChip-root jss80 jss85 MuiChip-outlined MuiChip-sizeSmall"><span class="MuiChip-label MuiChip-labelSmall jss81">ACCEPTED</span></div></div></div><p class="MuiTypography-root MuiTypography-body2" title="Author"><svg class="MuiSvgIcon-root jss78 MuiSvgIcon-fontSizeInherit" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg> <!-- -->Lyuma</p></div><div><div><div role="group" class="MuiButtonGroup-root"><button class="MuiButtonBase-root MuiButton-root MuiButton-outlined MuiButtonGroup-grouped MuiButtonGroup-groupedHorizontal MuiButtonGroup-groupedOutlined MuiButtonGroup-groupedOutlinedHorizontal MuiButtonGroup-groupedOutlined" tabindex="0" type="button" title="Copy link"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></svg></span></button><a class="MuiButtonBase-root MuiButton-root MuiButton-outlined MuiButtonGroup-grouped MuiButtonGroup-groupedHorizontal MuiButtonGroup-groupedOutlined MuiButtonGroup-groupedOutlinedHorizontal MuiButtonGroup-groupedOutlined" tabindex="0" aria-disabled="false" href="https://github.com/V-Sekai/v-sekai-proposals/blob/master/docs/decisions/20200602-manage-backend-with-k3s.md" target="_blank" rel="noopener" title="View/edit on Github"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></svg></span></a></div></div></div></div><div><div><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="context-and-problem-statement">Context and Problem Statement<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#context-and-problem-statement" title="Permanent link">¶</a></h2><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">We want a way to manage backend resources on one or more physical machines.</p><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="describe-the-proposed-option-and-how-it-helps-to-overcome-the-problem-or-limitation">Describe the proposed option and how it helps to overcome the problem or limitation<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#describe-the-proposed-option-and-how-it-helps-to-overcome-the-problem-or-limitation" title="Permanent link">¶</a></h2><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">We are using a lightweight Kubernetes implementation, k3s, to provide management of backend resources</p><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="describe-how-your-proposal-will-work-with-code-pseudo-code-mock-ups-or-diagrams">Describe how your proposal will work, with code, pseudo-code, mock-ups, or diagrams<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#describe-how-your-proposal-will-work-with-code-pseudo-code-mock-ups-or-diagrams" title="Permanent link">¶</a></h2><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="system-setup-done-once">System Setup (Done once)<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#system-setup-done-once" title="Permanent link">¶</a></h3><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Install Fedora 34 with a user account set as administrator.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Add authorized keys into ~/.ssh/authorized_keys</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">OPTIONAL: customize SSH port:
Set <code class="jss90">Port 2345</code> in /etc/ssh/sshd_config.</p><pre><code class="jss90">sudo semanage port -a -t ssh_port_t -p tcp 2345
sudo firewall-cmd --add-port=2345/tcp</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">REQUIRED: set <code class="jss90">PasswordAuthentication no</code> in /etc/ssh/sshd_config.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">OPTIONAL: Configure default DNS server:</p><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="etcnetworkmanagerconfdoverride-dnsconf">/etc/NetworkManager/conf.d/override-dns.conf<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#etcnetworkmanagerconfdoverride-dnsconf" title="Permanent link">¶</a></h4><pre><code class="jss90">[main]
dns=none
[ipv4]
method=auto
dns=8.8.8.8;4.2.2.2;
ignore-auto-dns=true</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="etcresolvconf">/etc/resolv.conf<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#etcresolvconf" title="Permanent link">¶</a></h4><pre><code class="jss90">search localhost
nameserver 1.0.0.1
nameserver 1.1.1.1</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="sshd-restart">sshd restart<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#sshd-restart" title="Permanent link">¶</a></h4><pre><code class="jss90">sudo service sshd restart
sudo firewall-cmd --add-masquerade --permanent
sudo systemctl restart firewalld
sudo yum install redhat-lsb-core container-selinux selinux-policy-base podman
sudo rpm -i https://github.com/rancher/k3s-selinux/releases/download/v0.1.1-rc1/k3s-selinux-0.1.1-rc1.el7.noarch.rpm
# Validate that ssh logins work, then run:
sudo service NetworkManager stop; sudo service NetworkManager start
sudo grubby --update-kernel=ALL --args=&quot;systemd.unified_cgroup_hierarchy=0&quot;</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now, reboot the system.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">First, create a new LVM Logical Volume named kubepvc XFS 100GB mounted at <code class="jss90">/kube</code>.
Add the following to /etc/fstab:</p><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="rancher">rancher<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#rancher" title="Permanent link">¶</a></h4><pre><code class="jss90"># If created manually, run `sudo blkid` and add:
# UUID=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee /kube   auto  defaults   0 0
/kube/rancher /var/lib/rancher    none bind 0 0`</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="kube-partition">kube partition<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#kube-partition" title="Permanent link">¶</a></h4><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now, setup the partition:</p><pre><code class="jss90">sudo mkdir -p /kube
sudo mount /kube
sudo mkdir -p /kube/pvc /kube/rancher /var/lib/rancher /root/.kube
sudo chcon -R -t container_file_t /kube/pvc
sudo mount /var/lib/rancher</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="selinux-patches">SELinux patches<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#selinux-patches" title="Permanent link">¶</a></h3><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">If your system uses SELinux, add the following SELinux module to allow dev-shm access. This will be necessary for python multiprocessing in containers, specifically usage of shm_lock, which is used by Emscripten.</p><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="dev-shmte">dev-shm.te<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#dev-shmte" title="Permanent link">¶</a></h4><pre><code class="jss90">module dev-shm 1.0;

require {
        type container_runtime_tmpfs_t;
        type container_t;
        class dir { getattr relabelto unlink ioctl execute append read setattr write lock create rename link search rmdir remove_name reparent add_name open };
        class file { map getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link execute_no_trans entrypoint execmod open };
        class shm { write destroy unix_write getattr create read setattr unix_read associate lock };
        class sock_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };
        class fifo_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };
        class lnk_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link };
}
#============= container_t ==============
allow container_t container_runtime_tmpfs_t:dir { getattr relabelto unlink ioctl execute append read setattr write lock create rename link search rmdir remove_name reparent add_name open };
# domain_can_mmap_files
allow container_t container_runtime_tmpfs_t:file { map getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link execute_no_trans entrypoint execmod open };
allow container_t container_runtime_tmpfs_t:shm { write destroy unix_write getattr create read setattr unix_read associate lock };
allow container_t container_runtime_tmpfs_t:sock_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };
allow container_t container_runtime_tmpfs_t:fifo_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };
allow container_t container_runtime_tmpfs_t:lnk_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link };</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now, install it with:</p><pre><code class="jss90">checkmodule -M -m dev-shm.te -o dev-shm.mod
semodule_package -m dev-shm.mod -o dev-shm.pp
sudo semodule -i dev-shm.pp</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="install-k3s-start-here-if-recreating">Install k3s (Start here if recreating)<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#install-k3s-start-here-if-recreating" title="Permanent link">¶</a></h3><pre><code class="jss90">curl -sfL https://raw.githubusercontent.com/rancher/k3s/master/install.sh | sh -s - server -o /root/.kube/config --default-local-storage-path /kube/pvc --disable=traefik --disable=servicelb --disable=flannel --disable=cni &#x27;--kubelet-arg=eviction-soft=memory.available&lt;0%,imagefs.available&lt;0%,nodefs.available&lt;0%&#x27; &#x27;--kubelet-arg=eviction-hard=memory.available&lt;0%,imagefs.available&lt;0%,nodefs.available&lt;0%&#x27;</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now you will need to obtain the DNS IAM credentials. In this example, we are working with these Route53 hosted domains: vsekai.org,vsekai.net,vsekai.com,vsekai.cloud,v-sekai.org,v-sekai.net,v-sekai.com,v-sekai.cloud,vsek.ai,v-sek.ai</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Install Helm services:</p><pre><code class="jss90">ACCESSKEY=AKIAABCDEFGHIJKLMNOP
SECRETKEY=XXXXXXXXXXXXXXXXXXXX

sudo helm repo add gocd https://gocd.github.io/helm-chart
sudo helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
sudo helm repo add bitnami https://charts.bitnami.com/bitnami
sudo helm repo add jetstack https://charts.jetstack.io
sudo helm repo update

# We are still using 3.2.3 - I have not figured out the upgrade process yet for external-dns

sudo helm install external-dns --set provider=aws --set aws.zoneType=public --set registry=noop --set aws.credentials.accessKey=&quot;$ACCESSKEY&quot; --set domainFilters=&#x27;{vsekai.org,vsekai.net,vsekai.com,vsekai.cloud,v-sekai.org,v-sekai.net,v-sekai.com,v-sekai.cloud,vsek.ai,v-sek.ai}&#x27; --set aws.credentials.secretKey=&quot;$SECRETKEY&quot;  bitnami/external-dns


# NOTE: Some of these commands may be outdated:
# They seem to refer to nginx-nginx-ingress but now it is nginx-ingress-nginx.
# Take the following with a grain of salt:

sudo kubectl create namespace ingress-nginx
sudo helm install --namespace ingress-nginx nginx ingress-nginx/ingress-nginx --set controller.replicaCount=2
sudo kubectl patch svc/nginx-nginx-ingress-controller -n kube-system --patch &#x27;{&quot;spec&quot;:{&quot;externalTrafficPolicy&quot;:&quot;Local&quot;}}&#x27;
sudo kubectl patch deployments/nginx-nginx-ingress-controller --patch &#x27;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;hostNetwork&quot;:true}}}}&#x27; -n kube-system

sudo kubectl get replicasets -n kube-system
# Find the oldest nginx-nginx-ingress-controller one and delete with
sudo kubectl delete replicasets -nginx-ingress-controller-abcdefg-whatever -n kube-system


# Some weird stuff we changed. I don&#x27;t think any of it is needed other than the above
# externalTrafficPolicy and hostNetwork configuration changes.

cat &gt; ingress-svc-edit.yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: nginx
    meta.helm.sh/release-namespace: ingress-nginx
    metallb.universe.tf/address-pool: default
  creationTimestamp: &quot;2021-04-30T02:33:02Z&quot;
  finalizers:
  - service.kubernetes.io/load-balancer-cleanup
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: nginx
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/version: 0.45.0
    helm.sh/chart: ingress-nginx-3.29.0
  name: nginx-ingress-nginx-controller
  namespace: ingress-nginx
spec:
  clusterIP: 10.43.219.102
  clusterIPs:
  - 10.43.219.102
  externalTrafficPolicy: Local
  healthCheckNodePort: 32689
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    nodePort: 32595
    port: 80
    protocol: TCP
    targetPort: http
  - name: https
    nodePort: 31937
    port: 443
    protocol: TCP
    targetPort: https
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: nginx
    app.kubernetes.io/name: ingress-nginx
  sessionAffinity: None
  type: LoadBalancer
status:
  loadBalancer:
    ingress:
    - ip: 999.999.999.999

Ctrl-D to save

sudo kubectl apply -f ingress-svc-edit.yaml

sudo kubectl patch -n ingress-nginx services/nginx-ingress-nginx-controller --patch &#x27;{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;metallb.universe.tf/address-pool&quot;:&quot;default&quot;}},&quot;spec&quot;:{&quot;externalTrafficPolicy&quot;:&quot;Local&quot;}}
sudo kubectl patch deployments/nginx-ingress-nginx-controller --patch &#x27;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;hostNetwork&quot;:true}}}}&#x27; -n ingress-nginx





sudo kubectl create namespace cert-manager
# Used --version v0.15.1 before; now v1.3.1
sudo helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.3.1 --set installCRDs=true
sudo kubectl --namespace cert-manager create secret generic prod-route53-credentials-secret --from-literal=secret-access-key=&quot;$SECRETKEY&quot;</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="ingressyaml-edit-accesskeyid">ingress.yaml (edit accessKeyID)<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#ingressyaml-edit-accesskeyid" title="Permanent link">¶</a></h4><pre><code class="jss90">apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
 name: letsencrypt-prod
 namespace: cert-manager
spec:
 acme:
   # The ACME server URL
   server: https://acme-v02.api.letsencrypt.org/directory
   # Email address used for ACME registration
   email: example@example.com
   # Name of a secret used to store the ACME account private key
   privateKeySecretRef:
     name: letsencrypt-prod
   # Enable the HTTP-01 challenge provider
   solvers:
   - http01:
       ingress:
         class: nginx
   #solvers:
   #- dns01:
   #   route53:
   #     region: us-east-1
   #     accessKeyID: AKIAABCDEFGHIJKLMNOP
   #     secretAccessKeySecretRef:
   #       name: prod-route53-credentials-secret
   #       key: secret-access-key
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: core-ingress
  annotations:
    kubernetes.io/ingress.class: &quot;nginx&quot;
    cert-manager.io/cluster-issuer: &quot;letsencrypt-prod&quot;
    nginx.ingress.kubernetes.io/hsts: &quot;false&quot;
    # nginx.ingress.kubernetes.io/add-base-url: &quot;true&quot;
    nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;
    nginx.ingress.kubernetes.io/configuration-snippet: |
      if ($host ~ ^(?!(ci))) {
        more_clear_headers &quot;Strict-Transport-Security&quot;;
      }
      if ($host ~ ^(.*\.?)vsekai\.([a-z]*)$ ) {
          set $subd $1;
          set $tld $2;
          set $newdomain v-sekai.$tld;
          rewrite ^/(.*)$ https://$subd$newdomain/$1;
      }
spec:
  tls:
  - hosts:
    - vsekai.cloud
    - v-sekai.cloud
    - uro.vsekai.cloud
    - uro.v-sekai.cloud
    - radiance.v-sekai.cloud
    - ci.radiance.v-sekai.cloud
    - ci.v-sekai.cloud
    - radiance.vsekai.cloud
    - ci.radiance.vsekai.cloud
    - ci.vsekai.cloud
    - hls.vsek.ai
    secretName: radiance-cert-secret1
  rules:
  - host: vsekai.cloud
  - host: v-sekai.cloud
  - host: uro.vsekai.cloud
  - host: uro.v-sekai.cloud
    http:
      paths:
      - path: /
        backend:
          serviceName: uro
          servicePort: 4000
  - host: hls.vsek.ai
    http:
      paths:
      - path: /
        backend:
          serviceName: nginx-rtmp-service
          servicePort: 80
  - host: radiance.vsekai.cloud
  - host: radiance.v-sekai.cloud
    http:
      paths:
      - path: /debug_headers
        backend:
          serviceName: echo-service
          servicePort: 8099
      - path: /
        backend:
          serviceName: echo1
          servicePort: 80
  - host: ci.vsekai.cloud
  - host: ci.v-sekai.cloud
    http:
      paths:
      - path: /
        backend:
          serviceName: gocd-server
          servicePort: 8153
  - host: ci.radiance.vsekai.cloud
  - host: ci.radiance.v-sekai.cloud
    http:
      paths:
      - path: /
        backend:
          serviceName: gocd-server
          servicePort: 8153</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Then:</p><pre><code class="jss90">sudo kubectl apply -f ingress.yaml</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="setting-up-metallb">Setting up metallb:<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#setting-up-metallb" title="Permanent link">¶</a></h3><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="metalconfigyaml">metalconfig.yaml<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#metalconfigyaml" title="Permanent link">¶</a></h4><pre><code class="jss90">apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 108.85.109.49/32 # &lt;--- this is the external. HOST IP</code></pre><pre><code class="jss90">sudo kubectl create namespace metallb-system
sudo kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;
sudo kubectl apply -f metalconfig.yml
sudo kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="setting-up-osxcross">Setting up osxcross<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#setting-up-osxcross" title="Permanent link">¶</a></h3><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">(Optional in theory, but you have to remove enabled platforms in gocd):</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Start by grabbing a legitmate copy of <code class="jss90">MacOSX10.15.sdk.tar.xz</code> from your local MacBook or Mac Mini.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Then do the following to build:</p><pre><code class="jss90">cd /opt
sudo chown `whoami` .
git clone https://github.com/tpoechtrager/osxcross.git /opt/osxcross
sudo chown root .
cd /opt/osxcross
mv MacOSX10.15.sdk.tar.xz /opt/osxcross/tarballs
UNATTENDED=1 ./build.sh

# In case host OS is newer than guest OS:
cp -p /lib64/libstdc++.so.6 /opt/osxcross/target/bin/</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">On SELinux systems, you may need to give containers read permissions:</p><pre><code class="jss90">sudo chcon -R unconfined_u:object_r:container_share_t:s0  /opt/osxcross</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="setting-up-gocd">Setting up gocd:<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#setting-up-gocd" title="Permanent link">¶</a></h3><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="gocdvaluesyaml">gocd_values.yaml<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#gocdvaluesyaml" title="Permanent link">¶</a></h4><pre><code class="jss90">agent:
  image:
    # agent.image.repository is the GoCD Agent image name
    repository: &quot;groupsinfra/gocd-agent-centos-8-groups&quot; # agent.image.tag is the GoCD Agent image&#x27;s tag
    tag: v20.7.0-groups-0.5.3
    # agent.image.pullPolicy is the GoCD Agent image&#x27;s pull policy

    pullPolicy: &quot;IfNotPresent&quot; # agent.replicaCount is the GoCD Agent replicas Count. Specify the number of GoCD agents to run
  replicaCount: 6
  security:
    ssh:
      enabled: true
      secretName: gocd-ssh
server:
  shouldPreconfigure: false
  security:
    ssh:
      enabled: true
      secretName: gocd-ssh
  env:
    extraEnvVars:
      - name: GOCD_PLUGIN_INSTALL_gitlab-oauth-authorization-plugin
        value: https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/releases/download/v2.0.1-52-exp/gitlab-oauth-authorization-plugin-2.0.1-52.jar</code></pre><h5 id="keygen">Keygen</h5><pre><code class="jss90">ssh-keygen -t rsa -b 4096 -C &quot;gocd-ssh-key&quot; -f gocd-ssh -P &#x27;&#x27;
( ssh-keyscan gitlab.com ; ssh-keyscan github.com ) &gt; gocd_known_hosts
sudo kubectl create secret generic gocd-ssh --from-file=id_rsa=gocd-ssh --from-file=id_rsa.pub=gocd-ssh.pub --from-file=known_hosts=gocd_known_hosts

# Chart version 1.37.0 is gocd v21.2.0
sudo helm install -f gocd_values.yaml gocd gocd/gocd --version 1.37.0
sudo chcon -R -t container_file_t /kube/pvc
# Installs a trash service on port 80 by default. Let&#x27;s delete it:
sudo kubectl delete ingress gocd-server
# Instead of using &quot;kubectl scale&quot;, scale agents by editing gocd_values.yaml
# and do &quot;sudo helm upgrade -f ....&quot;
sudo helm install -f gocd_values.yaml gocd gocd/gocd --version 1.37.0
# Make sure to enable the agents in the web UI, and assign them to Resources and Environments.</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="upgrade-process-make-sure-to-sudo-kubectl-delete-ingress-gocd-server-after-every-upgrade">Upgrade process (<strong>make sure to <code class="jss90">sudo kubectl delete ingress gocd-server</code> after every upgrade</strong>):<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#upgrade-process-make-sure-to-sudo-kubectl-delete-ingress-gocd-server-after-every-upgrade" title="Permanent link">¶</a></h4><pre><code class="jss90"># Disable and Delete all agents in the AGENTS tab of gocd.
Edit gocd_values.yaml and set agent version to latest (e.g. v21.2.0-groups-0.5.8)
sudo helm upgrade -f gocd_values.yaml gocd gocd/gocd --version 1.37.0
sudo kubectl delete ingress gocd-server
# Upgrade gocd-agent-dind:
sudo kubectl patch deployments/gocd-agent-dind --patch &#x27;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;gocd-agent-dind&quot;,&quot;image&quot;:&quot;gocd/gocd-agent-docker-dind:v21.2.0&quot;}]}}}}&#x27;
# You can also use patch to upgrade gocd-agent and gocd-server instead of upgrading via helm chart. I sometimes do it that way.
# Delete the old Agents on the web interface. Wait for the new agents to come up, and enable them and assign them as appropriate.</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="dockerhub">DockerHub<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#dockerhub" title="Permanent link">¶</a></h4><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Create DockerHub permissions: Create an account if you do not have one. Visit <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://hub.docker.com/settings/security">https://hub.docker.com/settings/security</a> and create an Access Token. Copy the token.</p><pre><code class="jss90">sudo  kubectl create secret docker-registry regcred --docker-server=https://index.docker.io/v1/ --docker-username=dockerhubuser --docker-password=XXXX --docker-email=your.dockerhub.email@example.com</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="osxcross">OSXCROSS<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#osxcross" title="Permanent link">¶</a></h4><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">For osxcross (OSX cross compiling), make sure the OSX compiler SDK <em>you created on mac</em> os located at /opt/osxcross.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">If you do not have osxcross (no access to Apple hardware), then you must create an empty directory at /opt/osxcross or remove the relevant volume mounts (and remove from enabled build targets in the gocd pipelines).</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now create Docker-in-Docker, and apply this file with <code class="jss90">kubectl create -f dind.yaml</code> or <code class="jss90">kubectl apply -f dind.yaml</code></p><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="dindyaml">dind.yaml<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#dindyaml" title="Permanent link">¶</a></h4><pre><code class="jss90">apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: gocd
    component: agent-dind
  name: gocd-agent-dind
  namespace: default
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: gocd
      component: agent-dind
      release: gocd
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: gocd
        component: agent-dind
        release: gocd
    spec:
      containers:
      - env:
        - name: GO_SERVER_URL
          value: http://gocd-server:8153/go
        image: gocd/gocd-agent-docker-dind:v21.2.0
        imagePullPolicy: IfNotPresent
        name: gocd-agent-dind
        resources: {}
        securityContext:
          privileged: true
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /root/.ssh
          name: ssh-secrets
          readOnly: true
        - mountPath: /root/.docker
          name: kaniko-secret
        - mountPath: /opt/osxcross
          name: opt-osxcross-volume
          readOnly: true
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext:
        fsGroup: 0
        runAsGroup: 0
        runAsUser: 0
      serviceAccount: default
      serviceAccountName: default
      terminationGracePeriodSeconds: 30
      volumes:
      - name: ssh-secrets
        secret:
          defaultMode: 256
          secretName: gocd-ssh
      - name: kaniko-secret
        secret:
          secretName: regcred
          items:
            - key: .dockerconfigjson
              path: config.json
      - name: opt-osxcross-volume
        hostPath:
          path: /opt/osxcross
          type: Directory</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="osxcross-gocd-agents">OSXCROSS GOCD Agents<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#osxcross-gocd-agents" title="Permanent link">¶</a></h3><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">To add osxcross support to the main agents, create the following patch:</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">gocd-agent-patch.yaml</p><pre><code class="jss90">apiVersion: apps/v1
kind: Deployment
metadata:
  name: gocd-agent
spec:
  template:
    spec:
      containers:
      - name: gocd-agent
        volumeMounts:
        - mountPath: /opt/osxcross
          name: opt-osxcross-volume
          readOnly: true
      volumes:
      - name: opt-osxcross-volume
        hostPath:
          path: /opt/osxcross
          type: Directory</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">and apply with:
<code class="jss90">bash
sudo kubectl patch deployments/gocd-agent -p &quot;$(cat gocd-agent-patch.yaml)&quot;</code></p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Make sure to enable the Agents when they come up on the GoCD Dashboard. Add every server to the &quot;<code class="jss90">developement</code>&quot; environment. Also, assign linux servers to &quot;<code class="jss90">mingw</code>&quot; and &quot;<code class="jss90">linux</code>&quot;. Assign the dind agents to &quot;<code class="jss90">dind</code>&quot;.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">For GitLab, go to <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://ci.v-sekai.cloud/go/admin/security/auth_configs">https://ci.v-sekai.cloud/go/admin/security/auth_configs</a> and select <code class="jss90">Create new authorization configuration</code> -&gt; <code class="jss90">gitlab-auth-config</code> / <code class="jss90">GitLab Authentication plugin</code> / follow documentation here: <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/blob/master/INSTALL.md">https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/blob/master/INSTALL.md</a> - <strong>Do not check Allow only known users to login yet</strong>. If this works, you can skip the text auth step and corresponding passwd commands.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Create Guest login:</p><ol start="1"><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Go to auth_configs, <code class="jss90">Create new authorization configuration</code> -&gt; <code class="jss90">guest-login</code> / <code class="jss90">Guest Login Plugin</code> / Fill out Go server URL / Username <code class="jss90">view</code> / Display name <code class="jss90">Guest</code>.</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Now, go to Roles Management. Create role <code class="jss90">guest</code>. Add Deny for all types and Resources <code class="jss90">*</code> as desired.</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">In an Incognito window, visit the CI system and login as Guest. Close the incognito window.</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Now, go to Users Management. Select view / Guest and select Roles -&gt; <code class="jss90">guest</code></span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Admin -&gt; Pipelines. Select Pipeline Group <code class="jss90">beta</code>, click + on the top right of the whole <em>group</em>, go to Roles, add <code class="jss90">guest</code>, and only check <strong>View</strong>. Save this.</span></li></ol><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">At this point, Guest should have permission to view pipelines, see logs, download artifacts but nothing else.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">For text auth, go to <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://ci.v-sekai.cloud/go/admin/security/auth_configs">https://ci.v-sekai.cloud/go/admin/security/auth_configs</a> and select <code class="jss90">Create new authorization configuration</code> -&gt; <code class="jss90">file-auth-config</code> / <code class="jss90">Password File Authentication plugin</code> / <code class="jss90">/godata/config/password.properties</code></p><pre><code class="jss90">sudo kubectl exec gocd-server-6d77846995-5l244 -- touch /godata/config/password.properties
sudo yum install httpd-tools
htpasswd -c -B passwd admin
cat passwd | sudo kubectl exec gocd-server-6d77846995-5l244 -- sudo tee /kubepvc/pvc/*/godata/config/password.properties</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now go to users page, edit your user and enable <code class="jss90">Global Admin</code>.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now go to file-auth-config, edit configuration, enable Allow only known users to login</p><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="gocd-config-repositories">gocd config repositories:<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#gocd-config-repositories" title="Permanent link">¶</a></h3><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Go to <strong>Admin -&gt; Config Repositories</strong></p><ul><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Config repository Name:</strong> groups-gocd-pipelines</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Plugin ID:</strong> JSON Configuration Plugin</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Material Type:</strong> Git</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>URL:</strong> git@gitlab.com:godot-groups/groups-gocd-pipelines</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Branch:</strong> master</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>GoCD pipeline files pattern:</strong> *.gopipeline.json</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph"><strong>GoCD environment files pattern:</strong> *.goenvironment.json</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph"><strong>Rules</strong></p></span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Allow:</strong> Pipeline Group: beta</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><strong>Allow:</strong> Environment: development</span></li></ul><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="setup-of-flux-gitops">Setup of flux GitOps:<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#setup-of-flux-gitops" title="Permanent link">¶</a></h3><pre><code class="jss90">wget https://github.com/fluxcd/flux/releases/download/1.20.2/fluxctl_linux_amd64
sudo cp fluxctl_linux_amd64 /usr/local/bin/fluxctl
sudo chmod +x /usr/local/bin/fluxctl
sudo helm repo add fluxcd https://charts.fluxcd.io
sudo kubectl apply -f https://raw.githubusercontent.com/fluxcd/helm-operator/master/deploy/crds.yaml
sudo kubectl create namespace flux
sudo kubectl identity --k8s-fwd-ns flux</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Fork the flux-config repository from here <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://github.com/V-Sekai/flux-config">https://github.com/V-Sekai/flux-config</a> into your own github account, and set GHUSER=your github account.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Now, in your fork of flux-config, go to project Settings -&gt; Deploy Keys and add the result of the above identity command. Make sure to check <strong>Allow write access</strong>.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Once you have done this, you can continue with the flux setup using your newly forked repository.</p><pre><code class="jss90">export GHUSER=&quot;xxxxxxxxx&quot;
sudo fluxctl install --git-user=${GHUSER} --git-email=${GHUSER}@users.noreply.github.com - -git-url=git@github.com:${GHUSER}/flux-config --git-path=workloads --namespace=flux &gt; fluxcmd_install.yaml
sudo kubectl apply -f fluxcmd_install.yaml
sudo fluxctl --k8s-fwd-ns flux
sudo fluxctl list-workloads --k8s-fwd-ns flux</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">FOR DEBUGGING ONLY: <code class="jss90">sudo setenforce permissive</code> - this appears to have no effect, so there is a different problem.</p><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="setting-up-cockroachdb">Setting up cockroachdb:<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#setting-up-cockroachdb" title="Permanent link">¶</a></h3><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="cockroachdbvaluesyaml">cockroachdb.values.yaml<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#cockroachdbvaluesyaml" title="Permanent link">¶</a></h4><pre><code class="jss90">statefulset:
  resources:
    limits:
      memory: &quot;8Gi&quot;
    requests:
      memory: &quot;8Gi&quot;
conf:
  cache: &quot;2Gi&quot;
  max-sql-memory: &quot;2Gi&quot;
tls:
  enabled: true</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="cockroachdb-install">CockroachDB install<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#cockroachdb-install" title="Permanent link">¶</a></h4><pre><code class="jss90">
# Helm version MAY be deprecated. We will switch to operator below.

#sudo helm install cockroachdb --values cockroachdb.values.yaml cockroachdb/cockroachdb
#sudo kubectl certificate approve default.node.cockroachdb-0
#sudo kubectl certificate approve default.node.cockroachdb-1
#sudo kubectl certificate approve default.node.cockroachdb-2
#sudo kubectl certificate approve default.client.root

wget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/manifests/operator.yaml -O cockroach-operator.yaml
sudo kubectl apply -f cockroach-operator.yaml

wget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/config/crd/bases/crdb.cockroachlabs.com_crdbclusters.yaml
sudo kubectl apply -f crdb.yaml

cat &gt; cockroachdb_extra_resource_certgen.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cockroachdb
  labels:
    app: cockroachdb
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cockroachdb
  labels:
    app: cockroachdb
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - secrets
  verbs:
  - create
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cockroachdb
  labels:
    app: cockroachdb
rules:
- apiGroups:
  - certificates.k8s.io
  resources:
  - certificatesigningrequests
  verbs:
  - create
  - get
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cockroachdb
  labels:
    app: cockroachdb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cockroachdb
subjects:
- kind: ServiceAccount
  name: cockroachdb
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cockroachdb
  labels:
    app: cockroachdb
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cockroachdb
subjects:
- kind: ServiceAccount
  name: cockroachdb
  namespace: default

Ctrl-D


# Note: may need to set up physicalVolume and physicalVolumeClaim objects for each cockraoch node.

# The permissions may be set wrong if you are upgrading. Fix them with:
sudo chown -R 1000581000 /kube/pvc/pvc-aaaaaaaaaaaaaaaaaa /kube/pvc/pvc-bbbbbbbbbbbbbbb /kube/pvc/pvc-cccccccccccccccccccccccccccccccc

# OLD curl -o client-secure.yaml https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/client-secure.yaml
# OLD sudo kubectl apply -f client-secure.yaml

wget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/examples/client-secure-operator.yaml
sudo kubectl apply -f client-secure-operator.yaml

sudo kubectl certificate approve default.client.uro-prod

sudo kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=cockroachdb-public</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">In SQL, write:</p><pre><code class="jss90">CREATE DATABASE uro_prod;
CREATE USER &#x27;uro-prod&#x27; WITH PASSWORD &#x27;blablablablaSOMEDATABASEPASSWORD&#x27;;
GRANT ALL ON DATABASE uro_prod to &quot;uro-prod&quot;;</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">To make backups:</p><pre><code class="jss90">sudo kubectl exec -it cockroachdb-client-secure -- ./cockroach dump --certs-dir=/cockroach-certs --host=cockroachdb-public uro_prod &gt; uro_prod_backup.txt</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Apply secrets:</p><pre><code class="jss90">(On dev machine) MIX_ENV=prod mix phx.gen.secret
# Copy the output of above, and copy the database password from above:
sudo kubectl create secret generic uro-prod --from-literal=secret-key-base=&#x27;GENERATED_WITH_ABOVE_COMMAND&#x27; --from-literal=pass=&#x27;blablablablaSOMEDATABASEPASSWORD&#x27;

sudo kubectl apply -f https://raw.githubusercontent.com/V-Sekai/uro/master/kubernetes.yaml</code></pre><h3 class="MuiTypography-root jss88 MuiTypography-h5 MuiTypography-gutterBottom" id="keeping-the-system-and-cluster-up-to-date">Keeping the system and cluster up-to-date<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#keeping-the-system-and-cluster-up-to-date" title="Permanent link">¶</a></h3><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="upgrading-fedora">Upgrading fedora<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#upgrading-fedora" title="Permanent link">¶</a></h4><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Start the upgrade process with:</p><pre><code class="jss90">sudo dnf upgrade --refresh
sudo dnf install dnf-plugin-system-upgrade
sudo dnf system-upgrade download --releasever=34</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Answer <code class="jss90">y</code> to all prompts confirming list of packages and new GPG keys, if any. Once successful, it displays:</p><pre><code class="jss90">Download complete! Use &#x27;dnf system-upgrade reboot&#x27; to start the upgrade.
To remove cached metadata and transaction use &#x27;dnf system-upgrade clean&#x27;
The downloaded packages were saved in cache until the next successful transaction.
You can remove cached packages by executing &#x27;dnf clean packages&#x27;.</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Complete the upgrade with:</p><pre><code class="jss90">sudo dnf system-upgrade reboot</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">This will bring the system down for about an hour.</p><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="upgrading-nginx-and-cert-manager">Upgrading nginx and cert-manager<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#upgrading-nginx-and-cert-manager" title="Permanent link">¶</a></h4><pre><code class="jss90">sudo helm repo update
# If the stable/nginx-ingress chart is still installed, make sure to helm uninstall nginx first.
sudo helm upgrade --namespace ingress-nginx nginx ingress-nginx/ingress-nginx --set controller.replicaCount=2
sudo helm upgrade cert-manager jetstack/cert-manager --namespace cert-manager --set installCRDs=true
### I was not able to get external-dns to upgrade, but it is not user-facing so we keep running the old version.
# sudo helm upgrade external-dns --reuse-values bitnami/external-dns</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="upgrading-k3s">Upgrading k3s<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#upgrading-k3s" title="Permanent link">¶</a></h4><pre><code class="jss90">curl -sfL https://raw.githubusercontent.com/rancher/k3s/master/install.sh | sh -s - server -o /root/.kube/config --default-local-storage-path /kube/pvc --no-deploy=servicelb --disable=traefik --disable=servicelb</code></pre><h4 class="MuiTypography-root jss88 MuiTypography-h6 MuiTypography-gutterBottom" id="upgrading-cockroachdb">Upgrading cockroachdb<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#upgrading-cockroachdb" title="Permanent link">¶</a></h4><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Run the shell:</p><pre><code class="jss90">sudo kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=cockroachdb-public</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">At the top of the shell prompt, it will say something like this. Copy the first two numbers from the CockroachDB CCL line. In this case, <code class="jss90">20.2</code></p><pre><code class="jss90">#
# Welcome to the CockroachDB SQL shell.
# All statements must be terminated by a semicolon.
# To exit, type: \q.
#
# Server version: CockroachDB CCL v20.2.2 (x86_64-unknown-linux-gnu</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Replace <code class="jss90">some.version</code> in the following command with the value we found above:</p><pre><code class="jss90">SET CLUSTER SETTING cluster.preserve_downgrade_option = &#x27;some.version&#x27;;</code></pre><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Finally, perform the upgrade:</p><pre><code class="jss90">sudo kubectl delete job cockroachdb-init
sudo helm upgrade cockroachdb cockroachdb/cockroachdb --values cockroachdb.values.yaml
curl -o client-secure.yaml https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/client-secure.yaml
sudo kubectl delete pods/cockroachdb-client-secure
sudo kubectl create -f client-secure.yaml</code></pre><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="positive-consequences-less-optional-greater">Positive Consequences <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#positive-consequences-less-optional-greater" title="Permanent link">¶</a></h2><ul><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Knowledge gains about service creation</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Operation experience</span></li></ul><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="negative-consequences-less-optional-greater">Negative Consequences <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#negative-consequences-less-optional-greater" title="Permanent link">¶</a></h2><ul><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Constant maintenance</span></li></ul><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="option-graveyard-less-same-as-above-greater">Option graveyard: <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#option-graveyard-less-same-as-above-greater" title="Permanent link">¶</a></h2><ul><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Option: Dedicated Servers</span></li><li class="jss91"><span class="MuiTypography-root MuiTypography-body1">Option: Virtual Machines</span></li></ul><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="if-this-enhancement-will-not-be-used-often-can-it-be-worked-around-with-a-few-lines-of-script">If this enhancement will not be used often, can it be worked around with a few lines of script?<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#if-this-enhancement-will-not-be-used-often-can-it-be-worked-around-with-a-few-lines-of-script" title="Permanent link">¶</a></h2><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Yes, it is possible to deploy this system using docker or in the root system.</p><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="is-there-a-reason-why-this-should-be-core-and-done-by-us">Is there a reason why this should be core and done by us?<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#is-there-a-reason-why-this-should-be-core-and-done-by-us" title="Permanent link">¶</a></h2><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Having experience with kubernetes and maintaining discipline will make scaling or service upgrades smoother in the future.</p><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="references-less-optional-greater">References <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#references-less-optional-greater" title="Permanent link">¶</a></h2><ul><li class="jss91"><span class="MuiTypography-root MuiTypography-body1"><a class="MuiTypography-root MuiLink-root MuiLink-underlineNone MuiTypography-colorPrimary" href="https://k3s.io/">https://k3s.io/</a></span></li></ul><h2 class="MuiTypography-root jss88 MuiTypography-h4 MuiTypography-gutterBottom" id="derivative-license">Derivative License<a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss89 MuiTypography-colorPrimary" href="#derivative-license" title="Permanent link">¶</a></h2><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Copyright (c) 2020-2021 V-Sekai contributors.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p><p class="MuiTypography-root MuiTypography-body1 MuiTypography-paragraph">THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p></div></div><hr class="MuiDivider-root jss67"/><nav class="jss68"><div></div><div class="jss69"><p class="MuiTypography-root jss70 MuiTypography-body1">Last edited by <!-- -->Lyuma</p><p class="MuiTypography-root jss70 MuiTypography-body1">on <!-- -->Sep 18, 2021 7:31 PM</p></div><div></div></nav></div><div class="jss74 jss75"></div></div></main><footer class="jss23"><div class="jss2"></div><div class="jss3 jss26"><p class="MuiTypography-root jss24 MuiTypography-body1">Powered by<!-- --> <a class="MuiTypography-root MuiLink-root MuiLink-underlineNone jss25 MuiTypography-colorPrimary" href="https://github.com/thomvaill/log4brains" target="_blank" rel="noopener">Log4brains</a> <span style="font-size:0.8em">(v1.0.0-beta.11)</span></p></div><div class="jss4"></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"projectName":"V-Sekai","currentAdr":{"slug":"20200602-manage-backend-with-k3s","package":null,"title":"Manage backend resources on one or more physical machines with K3S","status":"accepted","supersededBy":null,"tags":[],"deciders":[],"body":{"enhancedMdx":"\n## Context and Problem Statement\n\nWe want a way to manage backend resources on one or more physical machines.\n\n## Describe the proposed option and how it helps to overcome the problem or limitation\n\nWe are using a lightweight Kubernetes implementation, k3s, to provide management of backend resources\n\n## Describe how your proposal will work, with code, pseudo-code, mock-ups, or diagrams\n\n### System Setup (Done once)\n\nInstall Fedora 34 with a user account set as administrator.\n\nAdd authorized keys into ~/.ssh/authorized_keys\n\nOPTIONAL: customize SSH port:\nSet `Port 2345` in /etc/ssh/sshd_config.\n\n```bash\nsudo semanage port -a -t ssh_port_t -p tcp 2345\nsudo firewall-cmd --add-port=2345/tcp\n```\n\nREQUIRED: set `PasswordAuthentication no` in /etc/ssh/sshd_config.\n\nOPTIONAL: Configure default DNS server:\n\n\n#### /etc/NetworkManager/conf.d/override-dns.conf\n\n```ini\n[main]\ndns=none\n[ipv4]\nmethod=auto\ndns=8.8.8.8;4.2.2.2;\nignore-auto-dns=true\n```\n\n#### /etc/resolv.conf\n\n```bash\nsearch localhost\nnameserver 1.0.0.1\nnameserver 1.1.1.1\n```\n\n#### sshd restart\n\n```bash\nsudo service sshd restart\nsudo firewall-cmd --add-masquerade --permanent\nsudo systemctl restart firewalld\nsudo yum install redhat-lsb-core container-selinux selinux-policy-base podman\nsudo rpm -i https://github.com/rancher/k3s-selinux/releases/download/v0.1.1-rc1/k3s-selinux-0.1.1-rc1.el7.noarch.rpm\n# Validate that ssh logins work, then run:\nsudo service NetworkManager stop; sudo service NetworkManager start\nsudo grubby --update-kernel=ALL --args=\"systemd.unified_cgroup_hierarchy=0\"\n```\n\nNow, reboot the system.\n\nFirst, create a new LVM Logical Volume named kubepvc XFS 100GB mounted at `/kube`.\nAdd the following to /etc/fstab:\n\n#### rancher\n\n```\n# If created manually, run `sudo blkid` and add:\n# UUID=aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee /kube   auto  defaults   0 0\n/kube/rancher /var/lib/rancher    none bind 0 0`\n```\n\n#### kube partition\n\nNow, setup the partition:\n\n```bash\nsudo mkdir -p /kube\nsudo mount /kube\nsudo mkdir -p /kube/pvc /kube/rancher /var/lib/rancher /root/.kube\nsudo chcon -R -t container_file_t /kube/pvc\nsudo mount /var/lib/rancher\n```\n\n### SELinux patches\n\nIf your system uses SELinux, add the following SELinux module to allow dev-shm access. This will be necessary for python multiprocessing in containers, specifically usage of shm_lock, which is used by Emscripten.\n\n#### dev-shm.te\n\n```\nmodule dev-shm 1.0;\n\nrequire {\n        type container_runtime_tmpfs_t;\n        type container_t;\n        class dir { getattr relabelto unlink ioctl execute append read setattr write lock create rename link search rmdir remove_name reparent add_name open };\n        class file { map getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link execute_no_trans entrypoint execmod open };\n        class shm { write destroy unix_write getattr create read setattr unix_read associate lock };\n        class sock_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };\n        class fifo_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };\n        class lnk_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link };\n}\n#============= container_t ==============\nallow container_t container_runtime_tmpfs_t:dir { getattr relabelto unlink ioctl execute append read setattr write lock create rename link search rmdir remove_name reparent add_name open };\n# domain_can_mmap_files\nallow container_t container_runtime_tmpfs_t:file { map getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link execute_no_trans entrypoint execmod open };\nallow container_t container_runtime_tmpfs_t:shm { write destroy unix_write getattr create read setattr unix_read associate lock };\nallow container_t container_runtime_tmpfs_t:sock_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };\nallow container_t container_runtime_tmpfs_t:fifo_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link open };\nallow container_t container_runtime_tmpfs_t:lnk_file { getattr relabelto unlink ioctl execute append read setattr write lock create rename relabelfrom link };\n```\n\nNow, install it with:\n\n```bash\ncheckmodule -M -m dev-shm.te -o dev-shm.mod\nsemodule_package -m dev-shm.mod -o dev-shm.pp\nsudo semodule -i dev-shm.pp\n```\n\n### Install k3s (Start here if recreating)\n\n```bash\ncurl -sfL https://raw.githubusercontent.com/rancher/k3s/master/install.sh | sh -s - server -o /root/.kube/config --default-local-storage-path /kube/pvc --disable=traefik --disable=servicelb --disable=flannel --disable=cni '--kubelet-arg=eviction-soft=memory.available\u003c0%,imagefs.available\u003c0%,nodefs.available\u003c0%' '--kubelet-arg=eviction-hard=memory.available\u003c0%,imagefs.available\u003c0%,nodefs.available\u003c0%'\n\n```\n\nNow you will need to obtain the DNS IAM credentials. In this example, we are working with these Route53 hosted domains: vsekai.org,vsekai.net,vsekai.com,vsekai.cloud,v-sekai.org,v-sekai.net,v-sekai.com,v-sekai.cloud,vsek.ai,v-sek.ai\n\nInstall Helm services:\n\n```bash\nACCESSKEY=AKIAABCDEFGHIJKLMNOP\nSECRETKEY=XXXXXXXXXXXXXXXXXXXX\n\nsudo helm repo add gocd https://gocd.github.io/helm-chart\nsudo helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx\nsudo helm repo add bitnami https://charts.bitnami.com/bitnami\nsudo helm repo add jetstack https://charts.jetstack.io\nsudo helm repo update\n\n# We are still using 3.2.3 - I have not figured out the upgrade process yet for external-dns\n\nsudo helm install external-dns --set provider=aws --set aws.zoneType=public --set registry=noop --set aws.credentials.accessKey=\"$ACCESSKEY\" --set domainFilters='{vsekai.org,vsekai.net,vsekai.com,vsekai.cloud,v-sekai.org,v-sekai.net,v-sekai.com,v-sekai.cloud,vsek.ai,v-sek.ai}' --set aws.credentials.secretKey=\"$SECRETKEY\"  bitnami/external-dns\n\n\n# NOTE: Some of these commands may be outdated:\n# They seem to refer to nginx-nginx-ingress but now it is nginx-ingress-nginx.\n# Take the following with a grain of salt:\n\nsudo kubectl create namespace ingress-nginx\nsudo helm install --namespace ingress-nginx nginx ingress-nginx/ingress-nginx --set controller.replicaCount=2\nsudo kubectl patch svc/nginx-nginx-ingress-controller -n kube-system --patch '{\"spec\":{\"externalTrafficPolicy\":\"Local\"}}'\nsudo kubectl patch deployments/nginx-nginx-ingress-controller --patch '{\"spec\":{\"template\":{\"spec\":{\"hostNetwork\":true}}}}' -n kube-system\n\nsudo kubectl get replicasets -n kube-system\n# Find the oldest nginx-nginx-ingress-controller one and delete with\nsudo kubectl delete replicasets -nginx-ingress-controller-abcdefg-whatever -n kube-system\n\n\n# Some weird stuff we changed. I don't think any of it is needed other than the above\n# externalTrafficPolicy and hostNetwork configuration changes.\n\ncat \u003e ingress-svc-edit.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: nginx\n    meta.helm.sh/release-namespace: ingress-nginx\n    metallb.universe.tf/address-pool: default\n  creationTimestamp: \"2021-04-30T02:33:02Z\"\n  finalizers:\n  - service.kubernetes.io/load-balancer-cleanup\n  labels:\n    app.kubernetes.io/component: controller\n    app.kubernetes.io/instance: nginx\n    app.kubernetes.io/managed-by: Helm\n    app.kubernetes.io/name: ingress-nginx\n    app.kubernetes.io/version: 0.45.0\n    helm.sh/chart: ingress-nginx-3.29.0\n  name: nginx-ingress-nginx-controller\n  namespace: ingress-nginx\nspec:\n  clusterIP: 10.43.219.102\n  clusterIPs:\n  - 10.43.219.102\n  externalTrafficPolicy: Local\n  healthCheckNodePort: 32689\n  ipFamilies:\n  - IPv4\n  ipFamilyPolicy: SingleStack\n  ports:\n  - name: http\n    nodePort: 32595\n    port: 80\n    protocol: TCP\n    targetPort: http\n  - name: https\n    nodePort: 31937\n    port: 443\n    protocol: TCP\n    targetPort: https\n  selector:\n    app.kubernetes.io/component: controller\n    app.kubernetes.io/instance: nginx\n    app.kubernetes.io/name: ingress-nginx\n  sessionAffinity: None\n  type: LoadBalancer\nstatus:\n  loadBalancer:\n    ingress:\n    - ip: 999.999.999.999\n\nCtrl-D to save\n\nsudo kubectl apply -f ingress-svc-edit.yaml\n\nsudo kubectl patch -n ingress-nginx services/nginx-ingress-nginx-controller --patch '{\"metadata\":{\"annotations\":{\"metallb.universe.tf/address-pool\":\"default\"}},\"spec\":{\"externalTrafficPolicy\":\"Local\"}}\nsudo kubectl patch deployments/nginx-ingress-nginx-controller --patch '{\"spec\":{\"template\":{\"spec\":{\"hostNetwork\":true}}}}' -n ingress-nginx\n\n\n\n\n\nsudo kubectl create namespace cert-manager\n# Used --version v0.15.1 before; now v1.3.1\nsudo helm install cert-manager jetstack/cert-manager --namespace cert-manager --version v1.3.1 --set installCRDs=true\nsudo kubectl --namespace cert-manager create secret generic prod-route53-credentials-secret --from-literal=secret-access-key=\"$SECRETKEY\"\n```\n\n#### ingress.yaml (edit accessKeyID)\n\n```yaml\napiVersion: cert-manager.io/v1alpha2\nkind: ClusterIssuer\nmetadata:\n name: letsencrypt-prod\n namespace: cert-manager\nspec:\n acme:\n   # The ACME server URL\n   server: https://acme-v02.api.letsencrypt.org/directory\n   # Email address used for ACME registration\n   email: example@example.com\n   # Name of a secret used to store the ACME account private key\n   privateKeySecretRef:\n     name: letsencrypt-prod\n   # Enable the HTTP-01 challenge provider\n   solvers:\n   - http01:\n       ingress:\n         class: nginx\n   #solvers:\n   #- dns01:\n   #   route53:\n   #     region: us-east-1\n   #     accessKeyID: AKIAABCDEFGHIJKLMNOP\n   #     secretAccessKeySecretRef:\n   #       name: prod-route53-credentials-secret\n   #       key: secret-access-key\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: core-ingress\n  annotations:\n    kubernetes.io/ingress.class: \"nginx\"\n    cert-manager.io/cluster-issuer: \"letsencrypt-prod\"\n    nginx.ingress.kubernetes.io/hsts: \"false\"\n    # nginx.ingress.kubernetes.io/add-base-url: \"true\"\n    nginx.ingress.kubernetes.io/ssl-redirect: \"true\"\n    nginx.ingress.kubernetes.io/configuration-snippet: |\n      if ($host ~ ^(?!(ci))) {\n        more_clear_headers \"Strict-Transport-Security\";\n      }\n      if ($host ~ ^(.*\\.?)vsekai\\.([a-z]*)$ ) {\n          set $subd $1;\n          set $tld $2;\n          set $newdomain v-sekai.$tld;\n          rewrite ^/(.*)$ https://$subd$newdomain/$1;\n      }\nspec:\n  tls:\n  - hosts:\n    - vsekai.cloud\n    - v-sekai.cloud\n    - uro.vsekai.cloud\n    - uro.v-sekai.cloud\n    - radiance.v-sekai.cloud\n    - ci.radiance.v-sekai.cloud\n    - ci.v-sekai.cloud\n    - radiance.vsekai.cloud\n    - ci.radiance.vsekai.cloud\n    - ci.vsekai.cloud\n    - hls.vsek.ai\n    secretName: radiance-cert-secret1\n  rules:\n  - host: vsekai.cloud\n  - host: v-sekai.cloud\n  - host: uro.vsekai.cloud\n  - host: uro.v-sekai.cloud\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: uro\n          servicePort: 4000\n  - host: hls.vsek.ai\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: nginx-rtmp-service\n          servicePort: 80\n  - host: radiance.vsekai.cloud\n  - host: radiance.v-sekai.cloud\n    http:\n      paths:\n      - path: /debug_headers\n        backend:\n          serviceName: echo-service\n          servicePort: 8099\n      - path: /\n        backend:\n          serviceName: echo1\n          servicePort: 80\n  - host: ci.vsekai.cloud\n  - host: ci.v-sekai.cloud\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: gocd-server\n          servicePort: 8153\n  - host: ci.radiance.vsekai.cloud\n  - host: ci.radiance.v-sekai.cloud\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: gocd-server\n          servicePort: 8153\n```\n\nThen:\n\n```bash\nsudo kubectl apply -f ingress.yaml\n```\n\n### Setting up metallb:\n\n#### metalconfig.yaml\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 108.85.109.49/32 # \u003c--- this is the external. HOST IP\n```\n\n```bash\nsudo kubectl create namespace metallb-system\nsudo kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=\"$(openssl rand -base64 128)\"\nsudo kubectl apply -f metalconfig.yml\nsudo kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.9.3/manifests/metallb.yaml\n```\n\n### Setting up osxcross\n\n(Optional in theory, but you have to remove enabled platforms in gocd):\n\nStart by grabbing a legitmate copy of `MacOSX10.15.sdk.tar.xz` from your local MacBook or Mac Mini.\n\nThen do the following to build:\n\n```bash\ncd /opt\nsudo chown `whoami` .\ngit clone https://github.com/tpoechtrager/osxcross.git /opt/osxcross\nsudo chown root .\ncd /opt/osxcross\nmv MacOSX10.15.sdk.tar.xz /opt/osxcross/tarballs\nUNATTENDED=1 ./build.sh\n\n# In case host OS is newer than guest OS:\ncp -p /lib64/libstdc++.so.6 /opt/osxcross/target/bin/\n```\n\nOn SELinux systems, you may need to give containers read permissions:\n\n```bash\nsudo chcon -R unconfined_u:object_r:container_share_t:s0  /opt/osxcross\n```\n\n### Setting up gocd:\n\n#### gocd_values.yaml\n\n```yaml\nagent:\n  image:\n    # agent.image.repository is the GoCD Agent image name\n    repository: \"groupsinfra/gocd-agent-centos-8-groups\" # agent.image.tag is the GoCD Agent image's tag\n    tag: v20.7.0-groups-0.5.3\n    # agent.image.pullPolicy is the GoCD Agent image's pull policy\n\n    pullPolicy: \"IfNotPresent\" # agent.replicaCount is the GoCD Agent replicas Count. Specify the number of GoCD agents to run\n  replicaCount: 6\n  security:\n    ssh:\n      enabled: true\n      secretName: gocd-ssh\nserver:\n  shouldPreconfigure: false\n  security:\n    ssh:\n      enabled: true\n      secretName: gocd-ssh\n  env:\n    extraEnvVars:\n      - name: GOCD_PLUGIN_INSTALL_gitlab-oauth-authorization-plugin\n        value: https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/releases/download/v2.0.1-52-exp/gitlab-oauth-authorization-plugin-2.0.1-52.jar\n```\n\n##### Keygen\n\n```bash\nssh-keygen -t rsa -b 4096 -C \"gocd-ssh-key\" -f gocd-ssh -P ''\n( ssh-keyscan gitlab.com ; ssh-keyscan github.com ) \u003e gocd_known_hosts\nsudo kubectl create secret generic gocd-ssh --from-file=id_rsa=gocd-ssh --from-file=id_rsa.pub=gocd-ssh.pub --from-file=known_hosts=gocd_known_hosts\n\n# Chart version 1.37.0 is gocd v21.2.0\nsudo helm install -f gocd_values.yaml gocd gocd/gocd --version 1.37.0\nsudo chcon -R -t container_file_t /kube/pvc\n# Installs a trash service on port 80 by default. Let's delete it:\nsudo kubectl delete ingress gocd-server\n# Instead of using \"kubectl scale\", scale agents by editing gocd_values.yaml\n# and do \"sudo helm upgrade -f ....\"\nsudo helm install -f gocd_values.yaml gocd gocd/gocd --version 1.37.0\n# Make sure to enable the agents in the web UI, and assign them to Resources and Environments.\n```\n\n#### Upgrade process (**make sure to `sudo kubectl delete ingress gocd-server` after every upgrade**):\n\n```bash\n# Disable and Delete all agents in the AGENTS tab of gocd.\nEdit gocd_values.yaml and set agent version to latest (e.g. v21.2.0-groups-0.5.8)\nsudo helm upgrade -f gocd_values.yaml gocd gocd/gocd --version 1.37.0\nsudo kubectl delete ingress gocd-server\n# Upgrade gocd-agent-dind:\nsudo kubectl patch deployments/gocd-agent-dind --patch '{\"spec\":{\"template\":{\"spec\":{\"containers\":[{\"name\":\"gocd-agent-dind\",\"image\":\"gocd/gocd-agent-docker-dind:v21.2.0\"}]}}}}'\n# You can also use patch to upgrade gocd-agent and gocd-server instead of upgrading via helm chart. I sometimes do it that way.\n# Delete the old Agents on the web interface. Wait for the new agents to come up, and enable them and assign them as appropriate.\n```\n\n#### DockerHub\n\nCreate DockerHub permissions: Create an account if you do not have one. Visit https://hub.docker.com/settings/security and create an Access Token. Copy the token.\n\n```bash\nsudo  kubectl create secret docker-registry regcred --docker-server=https://index.docker.io/v1/ --docker-username=dockerhubuser --docker-password=XXXX --docker-email=your.dockerhub.email@example.com\n```\n\n#### OSXCROSS\n\nFor osxcross (OSX cross compiling), make sure the OSX compiler SDK *you created on mac* os located at /opt/osxcross.\n\nIf you do not have osxcross (no access to Apple hardware), then you must create an empty directory at /opt/osxcross or remove the relevant volume mounts (and remove from enabled build targets in the gocd pipelines).\n\nNow create Docker-in-Docker, and apply this file with `kubectl create -f dind.yaml` or `kubectl apply -f dind.yaml`\n\n#### dind.yaml\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: gocd\n    component: agent-dind\n  name: gocd-agent-dind\n  namespace: default\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 2\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: gocd\n      component: agent-dind\n      release: gocd\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: gocd\n        component: agent-dind\n        release: gocd\n    spec:\n      containers:\n      - env:\n        - name: GO_SERVER_URL\n          value: http://gocd-server:8153/go\n        image: gocd/gocd-agent-docker-dind:v21.2.0\n        imagePullPolicy: IfNotPresent\n        name: gocd-agent-dind\n        resources: {}\n        securityContext:\n          privileged: true\n        terminationMessagePath: /dev/termination-log\n        terminationMessagePolicy: File\n        volumeMounts:\n        - mountPath: /root/.ssh\n          name: ssh-secrets\n          readOnly: true\n        - mountPath: /root/.docker\n          name: kaniko-secret\n        - mountPath: /opt/osxcross\n          name: opt-osxcross-volume\n          readOnly: true\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      schedulerName: default-scheduler\n      securityContext:\n        fsGroup: 0\n        runAsGroup: 0\n        runAsUser: 0\n      serviceAccount: default\n      serviceAccountName: default\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: ssh-secrets\n        secret:\n          defaultMode: 256\n          secretName: gocd-ssh\n      - name: kaniko-secret\n        secret:\n          secretName: regcred\n          items:\n            - key: .dockerconfigjson\n              path: config.json\n      - name: opt-osxcross-volume\n        hostPath:\n          path: /opt/osxcross\n          type: Directory\n```\n\n### OSXCROSS GOCD Agents\n\nTo add osxcross support to the main agents, create the following patch:\n\ngocd-agent-patch.yaml\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: gocd-agent\nspec:\n  template:\n    spec:\n      containers:\n      - name: gocd-agent\n        volumeMounts:\n        - mountPath: /opt/osxcross\n          name: opt-osxcross-volume\n          readOnly: true\n      volumes:\n      - name: opt-osxcross-volume\n        hostPath:\n          path: /opt/osxcross\n          type: Directory\n```\n\nand apply with:\n```bash\nsudo kubectl patch deployments/gocd-agent -p \"$(cat gocd-agent-patch.yaml)\"\n```\n\nMake sure to enable the Agents when they come up on the GoCD Dashboard. Add every server to the \"`developement`\" environment. Also, assign linux servers to \"`mingw`\" and \"`linux`\". Assign the dind agents to \"`dind`\".\n\n\nFor GitLab, go to https://ci.v-sekai.cloud/go/admin/security/auth_configs and select `Create new authorization configuration` -\u003e `gitlab-auth-config` / `GitLab Authentication plugin` / follow documentation here: https://github.com/gocd-contrib/gitlab-oauth-authorization-plugin/blob/master/INSTALL.md - **Do not check Allow only known users to login yet**. If this works, you can skip the text auth step and corresponding passwd commands.\n\nCreate Guest login:\n\n1. Go to auth_configs, `Create new authorization configuration` -\u003e `guest-login` / `Guest Login Plugin` / Fill out Go server URL / Username `view` / Display name `Guest`.\n2. Now, go to Roles Management. Create role `guest`. Add Deny for all types and Resources `*` as desired.\n3. In an Incognito window, visit the CI system and login as Guest. Close the incognito window.\n4. Now, go to Users Management. Select view / Guest and select Roles -\u003e `guest`\n5. Admin -\u003e Pipelines. Select Pipeline Group `beta`, click + on the top right of the whole *group*, go to Roles, add `guest`, and only check **View**. Save this.\n\nAt this point, Guest should have permission to view pipelines, see logs, download artifacts but nothing else.\n\nFor text auth, go to https://ci.v-sekai.cloud/go/admin/security/auth_configs and select `Create new authorization configuration` -\u003e `file-auth-config` / `Password File Authentication plugin` / `/godata/config/password.properties`\n\n```bash\nsudo kubectl exec gocd-server-6d77846995-5l244 -- touch /godata/config/password.properties\nsudo yum install httpd-tools\nhtpasswd -c -B passwd admin\ncat passwd | sudo kubectl exec gocd-server-6d77846995-5l244 -- sudo tee /kubepvc/pvc/*/godata/config/password.properties\n```\n\nNow go to users page, edit your user and enable `Global Admin`.\n\nNow go to file-auth-config, edit configuration, enable Allow only known users to login\n\n### gocd config repositories:\n\nGo to **Admin -\u003e Config Repositories**\n\n- **Config repository Name:** groups-gocd-pipelines\n- **Plugin ID:** JSON Configuration Plugin\n- **Material Type:** Git\n- **URL:** git@gitlab.com:godot-groups/groups-gocd-pipelines\n- **Branch:** master\n- **GoCD pipeline files pattern:** \\*.gopipeline.json\n- **GoCD environment files pattern:** \\*.goenvironment.json\n  \n**Rules**\n\n- **Allow:** Pipeline Group: beta\n- **Allow:** Environment: development\n\n### Setup of flux GitOps:\n\n```bash\nwget https://github.com/fluxcd/flux/releases/download/1.20.2/fluxctl_linux_amd64\nsudo cp fluxctl_linux_amd64 /usr/local/bin/fluxctl\nsudo chmod +x /usr/local/bin/fluxctl\nsudo helm repo add fluxcd https://charts.fluxcd.io\nsudo kubectl apply -f https://raw.githubusercontent.com/fluxcd/helm-operator/master/deploy/crds.yaml\nsudo kubectl create namespace flux\nsudo kubectl identity --k8s-fwd-ns flux\n```\n\nFork the flux-config repository from here https://github.com/V-Sekai/flux-config into your own github account, and set GHUSER=your github account.\n\nNow, in your fork of flux-config, go to project Settings -\u003e Deploy Keys and add the result of the above identity command. Make sure to check **Allow write access**.\n\nOnce you have done this, you can continue with the flux setup using your newly forked repository.\n\n```bash\nexport GHUSER=\"xxxxxxxxx\"\nsudo fluxctl install --git-user=${GHUSER} --git-email=${GHUSER}@users.noreply.github.com - -git-url=git@github.com:${GHUSER}/flux-config --git-path=workloads --namespace=flux \u003e fluxcmd_install.yaml\nsudo kubectl apply -f fluxcmd_install.yaml\nsudo fluxctl --k8s-fwd-ns flux\nsudo fluxctl list-workloads --k8s-fwd-ns flux\n```\n\n\nFOR DEBUGGING ONLY: `sudo setenforce permissive` - this appears to have no effect, so there is a different problem.\n\n### Setting up cockroachdb:\n\n#### cockroachdb.values.yaml\n\n```yaml\nstatefulset:\n  resources:\n    limits:\n      memory: \"8Gi\"\n    requests:\n      memory: \"8Gi\"\nconf:\n  cache: \"2Gi\"\n  max-sql-memory: \"2Gi\"\ntls:\n  enabled: true\n```\n\n#### CockroachDB install\n\n```bash\n\n# Helm version MAY be deprecated. We will switch to operator below.\n\n#sudo helm install cockroachdb --values cockroachdb.values.yaml cockroachdb/cockroachdb\n#sudo kubectl certificate approve default.node.cockroachdb-0\n#sudo kubectl certificate approve default.node.cockroachdb-1\n#sudo kubectl certificate approve default.node.cockroachdb-2\n#sudo kubectl certificate approve default.client.root\n\nwget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/manifests/operator.yaml -O cockroach-operator.yaml\nsudo kubectl apply -f cockroach-operator.yaml\n\nwget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/config/crd/bases/crdb.cockroachlabs.com_crdbclusters.yaml\nsudo kubectl apply -f crdb.yaml\n\ncat \u003e cockroachdb_extra_resource_certgen.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: cockroachdb\n  labels:\n    app: cockroachdb\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: cockroachdb\n  labels:\n    app: cockroachdb\nrules:\n- apiGroups:\n  - \"\"\n  resources:\n  - secrets\n  verbs:\n  - create\n  - get\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: cockroachdb\n  labels:\n    app: cockroachdb\nrules:\n- apiGroups:\n  - certificates.k8s.io\n  resources:\n  - certificatesigningrequests\n  verbs:\n  - create\n  - get\n  - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: cockroachdb\n  labels:\n    app: cockroachdb\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: cockroachdb\nsubjects:\n- kind: ServiceAccount\n  name: cockroachdb\n  namespace: default\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: cockroachdb\n  labels:\n    app: cockroachdb\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: cockroachdb\nsubjects:\n- kind: ServiceAccount\n  name: cockroachdb\n  namespace: default\n\nCtrl-D\n\n\n# Note: may need to set up physicalVolume and physicalVolumeClaim objects for each cockraoch node.\n\n# The permissions may be set wrong if you are upgrading. Fix them with:\nsudo chown -R 1000581000 /kube/pvc/pvc-aaaaaaaaaaaaaaaaaa /kube/pvc/pvc-bbbbbbbbbbbbbbb /kube/pvc/pvc-cccccccccccccccccccccccccccccccc\n\n# OLD curl -o client-secure.yaml https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/client-secure.yaml\n# OLD sudo kubectl apply -f client-secure.yaml\n\nwget https://raw.githubusercontent.com/cockroachdb/cockroach-operator/master/examples/client-secure-operator.yaml\nsudo kubectl apply -f client-secure-operator.yaml\n\nsudo kubectl certificate approve default.client.uro-prod\n\nsudo kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=cockroachdb-public\n```\n\nIn SQL, write:\n\n```sql\nCREATE DATABASE uro_prod;\nCREATE USER 'uro-prod' WITH PASSWORD 'blablablablaSOMEDATABASEPASSWORD';\nGRANT ALL ON DATABASE uro_prod to \"uro-prod\";\n```\n\nTo make backups:\n\n```bash\nsudo kubectl exec -it cockroachdb-client-secure -- ./cockroach dump --certs-dir=/cockroach-certs --host=cockroachdb-public uro_prod \u003e uro_prod_backup.txt\n```\n\nApply secrets:\n\n```bash\n(On dev machine) MIX_ENV=prod mix phx.gen.secret\n# Copy the output of above, and copy the database password from above:\nsudo kubectl create secret generic uro-prod --from-literal=secret-key-base='GENERATED_WITH_ABOVE_COMMAND' --from-literal=pass='blablablablaSOMEDATABASEPASSWORD'\n\nsudo kubectl apply -f https://raw.githubusercontent.com/V-Sekai/uro/master/kubernetes.yaml\n```\n\n### Keeping the system and cluster up-to-date\n\n#### Upgrading fedora\n\nStart the upgrade process with:\n\n```bash\nsudo dnf upgrade --refresh\nsudo dnf install dnf-plugin-system-upgrade\nsudo dnf system-upgrade download --releasever=34\n```\n\nAnswer `y` to all prompts confirming list of packages and new GPG keys, if any. Once successful, it displays:\n\n```bash\nDownload complete! Use 'dnf system-upgrade reboot' to start the upgrade.\nTo remove cached metadata and transaction use 'dnf system-upgrade clean'\nThe downloaded packages were saved in cache until the next successful transaction.\nYou can remove cached packages by executing 'dnf clean packages'.\n```\n\nComplete the upgrade with:\n\n```bash\nsudo dnf system-upgrade reboot\n```\n\nThis will bring the system down for about an hour.\n\n#### Upgrading nginx and cert-manager\n\n```bash\nsudo helm repo update\n# If the stable/nginx-ingress chart is still installed, make sure to helm uninstall nginx first.\nsudo helm upgrade --namespace ingress-nginx nginx ingress-nginx/ingress-nginx --set controller.replicaCount=2\nsudo helm upgrade cert-manager jetstack/cert-manager --namespace cert-manager --set installCRDs=true\n### I was not able to get external-dns to upgrade, but it is not user-facing so we keep running the old version.\n# sudo helm upgrade external-dns --reuse-values bitnami/external-dns\n```\n\n#### Upgrading k3s\n\n```bash\ncurl -sfL https://raw.githubusercontent.com/rancher/k3s/master/install.sh | sh -s - server -o /root/.kube/config --default-local-storage-path /kube/pvc --no-deploy=servicelb --disable=traefik --disable=servicelb\n```\n\n#### Upgrading cockroachdb\n\nRun the shell:\n\n```bash\nsudo kubectl exec -it cockroachdb-client-secure -- ./cockroach sql --certs-dir=/cockroach-certs --host=cockroachdb-public\n```\n\nAt the top of the shell prompt, it will say something like this. Copy the first two numbers from the CockroachDB CCL line. In this case, `20.2`\n\n```bash\n#\n# Welcome to the CockroachDB SQL shell.\n# All statements must be terminated by a semicolon.\n# To exit, type: \\q.\n#\n# Server version: CockroachDB CCL v20.2.2 (x86_64-unknown-linux-gnu\n```\n\nReplace `some.version` in the following command with the value we found above:\n\n```sql\nSET CLUSTER SETTING cluster.preserve_downgrade_option = 'some.version';\n```\n\nFinally, perform the upgrade:\n\n```bash\nsudo kubectl delete job cockroachdb-init\nsudo helm upgrade cockroachdb cockroachdb/cockroachdb --values cockroachdb.values.yaml\ncurl -o client-secure.yaml https://raw.githubusercontent.com/cockroachdb/cockroach/master/cloud/kubernetes/client-secure.yaml\nsudo kubectl delete pods/cockroachdb-client-secure\nsudo kubectl create -f client-secure.yaml\n```\n\n## Positive Consequences \u003c!-- optional --\u003e\n\n- Knowledge gains about service creation\n- Operation experience\n\n## Negative Consequences \u003c!-- optional --\u003e\n\n- Constant maintenance\n\n## Option graveyard: \u003c!-- same as above --\u003e\n\n* Option: Dedicated Servers\n* Option: Virtual Machines\n\n## If this enhancement will not be used often, can it be worked around with a few lines of script?\n\nYes, it is possible to deploy this system using docker or in the root system.\n\n## Is there a reason why this should be core and done by us?\n\nHaving experience with kubernetes and maintaining discipline will make scaling or service upgrades smoother in the future.\n\n## References \u003c!-- optional --\u003e\n\n- https://k3s.io/\n\n## Derivative License\n\nCopyright (c) 2020-2021 V-Sekai contributors.\n\nPermission is hereby granted, free of charge, to any person obtaining a copy\nof this software and associated documentation files (the \"Software\"), to deal\nin the Software without restriction, including without limitation the rights\nto use, copy, modify, merge, publish, distribute, sublicense, and/or sell\ncopies of the Software, and to permit persons to whom the Software is\nfurnished to do so, subject to the following conditions:\n\nThe above copyright notice and this permission notice shall be included in all\ncopies or substantial portions of the Software.\n\nTHE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\nIMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\nFITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\nAUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\nLIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\nOUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\nSOFTWARE.\n"},"creationDate":"2021-05-29T20:11:38.000Z","lastEditDate":"2021-09-18T19:31:15.000Z","lastEditAuthor":"Lyuma","publicationDate":null,"file":{"relativePath":"docs/decisions/20200602-manage-backend-with-k3s.md","absolutePath":"/home/runner/work/v-sekai-proposals/v-sekai-proposals/docs/decisions/20200602-manage-backend-with-k3s.md"},"repository":{"provider":"github","viewUrl":"https://github.com/V-Sekai/v-sekai-proposals/blob/master/docs/decisions/20200602-manage-backend-with-k3s.md"}},"l4bVersion":"1.0.0-beta.11"},"__N_SSG":true},"page":"/adr/[...slug]","query":{"slug":["20200602-manage-backend-with-k3s"]},"buildId":"crlZoZovn1qU2m39jxDF6","assetPrefix":"/v-sekai-proposals/log4brains","runtimeConfig":{},"nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/v-sekai-proposals/log4brains/_next/static/chunks/polyfills-694d8cb7f00ed89b8e7e.js"></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/main-58ab0a31548da3be79d9.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/commons.e15110c59e990a2b9d16.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/a3e17150ead73d62fba7a33a50672ae3f72841a5.801a9822111e83a35730.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/pages/_app-02e215af84c34c72dcf0.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/364bddfb.28847971f0e02b167249.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/3da477db.e49cd5277ed36ace32c1.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/3b07cb59.4f0af644828e83722dc4.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/b4e962f4.209b5add68e2810d9a93.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/39d4b69998343c06c2f6d09982e0011fc76b6c1e.6868553c766a0e95aa6f.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/45d2d314fc8da5e3d79852782e4a432ad4da6771.51549e4f3459c73f0f60.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/chunks/pages/adr/%5B...slug%5D-ce82ea9cfbf663c4d396.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/crlZoZovn1qU2m39jxDF6/_buildManifest.js" async=""></script><script src="/v-sekai-proposals/log4brains/_next/static/crlZoZovn1qU2m39jxDF6/_ssgManifest.js" async=""></script></body></html>